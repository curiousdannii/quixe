/* Quixe -- a Glulx VM interpreter written in Javascript
 * Designed by Andrew Plotkin <erkyrath@eblong.com>
 * <http://eblong.com/zarf/glulx/quixe/>
 * 
 * This Javascript library is copyright 2010-2016 by Andrew Plotkin.
 * It is distributed under the MIT license; see the "LICENSE" file.
 *
 * For documentation, see the README.txt or the web page noted above.
 * For information on getting Quixe installed on a web page, see the
 * comments in the gi_load.js file.
 *
 * This library makes use of jQuery utility functions (but it does not
 * manipulate DOM). It has been tested with jQuery 1.11.2 (included),
 * but should work equally well with jQuery 2.
 *
 *
 * Some interpreter behaviors can be customized by adding attributes to
 * the game_options object. (See gi_load.js for more about this object.)
 * Quixe currently understands two debugging options:
 *
 *   rethrow_exceptions: If true, any fatal VM errors encountered during
 *     play will be allowed to bubble up to the browser. If you're using
 *     a browser debugging facility, this may give you more information
 *     than the usual red "fatal-error" banner.
 *
 *   debug_info_chunk: If true, Quixe loads a "Dbug" chunk from the
 *     blorb file. The chunk should contain the gameinfo.dbg data
 *     generated by the Inform compiler when the game was compiled.
 *
 * The point of the debug_info_chunk option is that if a fatal error
 * occurs, the browser's debug console will show the I6 stack dump at
 * the point of the error; and this dump will contain both the name and
 * address of every I6 function on the stack.
 *
 * To set this up, you need to use the blorbtool.py script to add the
 * gameinfo.dbg file to the compiled blorb:
 *
 *   blorbtool.py test.gblorb import Dbug gameinfo.dbg
 *
 * Then add "debug_info_chunk: true" to the game_options object.
 */
Quixe=function(){function e(e,n){jn=e;var r,t,s=jn.slice(0,64);for(r=0;r<s.length;r++)t=s[r].toString(16),t.length<2&&(t="0"+t),s[r]=t;Fn=s.join(""),n&&(Ln=n.rethrow_exceptions,An=n.do_vm_autosave,En=n.clear_vm_autosave),n&&n.debug_info_chunk&&dn()}function n(){if(pn.vm_started)return void Glk.fatal_error("Quixe was inited twice!");try{o(),B(),qe(),hn()}catch(e){if(e.stack&&s("JS stack dump:\n"+e.stack),a(),Glk.fatal_error("Quixe init: "+t(e)),Ln)throw e}}function r(){try{pn.done_executing=pn.vm_stopped,hn()}catch(e){if(e.stack&&s("JS stack dump:\n"+e.stack),a(),Glk.fatal_error("Quixe run: "+t(e)),Ln)throw e}}function t(e){if("string"==typeof e)return e;var n=e.toString();return e.message&&(n=n+" "+e.message),e.fileName&&(n=n+" "+e.fileName),e.lineNumber&&(n=n+" line:"+e.lineNumber),e.name&&(n=n+" "+e.name),e.number&&(n=n+" "+e.number),n}function s(e){window.console&&console.log?console.log(e):window.opera&&opera.postError&&opera.postError(e)}function a(){if(Nn&&Nn.length){var e,n,r,t,a=[];for(e=0;e<Nn.length;e++)t=Nn[e],t.vmfunc.funcaddr?(n="0x"+t.vmfunc.funcaddr.toString(16),r=sr.functionmap[t.vmfunc.funcaddr],r&&(n+=' "'+r.name+'"'),a.push(n)):a.push("(anonymous)");s("VM stack dump: "+a.join(", "))}}function o(){var e,n;for(e=0;e<256;e++)n=e.toString(16),e<16&&(n="0"+n),mn[e]=n;for(e=0;e<256;e++)n=e>=32&&e<127?34==e||39==e||92==e?"\\"+String.fromCharCode(e):String.fromCharCode(e):10==e?"\\n":"\\x"+mn[e],vn[e]=n}function i(e,n){return 16777216*e[n]+65536*e[n+1]+256*e[n+2]+e[n+3]}function l(e,n){return 256*e[n]+e[n+1]}function f(e,n){return e[n]}function c(e){return Gn[e]}function u(e){return 256*Gn[e]+Gn[e+1]}function d(e){return 16777216*Gn[e]+65536*Gn[e+1]+256*Gn[e+2]+Gn[e+3]}function h(e,n){return Gn.slice(e,e+n)}function p(e,n){Gn[e]=255&n}function m(e,n){Gn[e]=n>>8&255,Gn[e+1]=255&n}function v(e,n){Gn[e]=n>>24&255,Gn[e+1]=n>>16&255,Gn[e+2]=n>>8&255,Gn[e+3]=255&n}function g(e,n){for(var r=0;r<n.length;r++)e.push(n.charCodeAt(r))}function _(e,n){e.push(n>>24&255),e.push(n>>16&255),e.push(n>>8&255),e.push(255&n)}function w(e,n){e.push(n>>8&255),e.push(255&n)}function k(e,n){e.push(255&n)}function b(e,n,r){e[n]=r>>24&255,e[n+1]=r>>16&255,e[n+2]=r>>8&255,e[n+3]=255&r}function y(e,n,r){return String.fromCharCode.apply(this,e.slice(n,n+r))}function x(e){return Gn[e]>=128?"0xffffff"+mn[Gn[e]]:"0x"+mn[Gn[e]]}function M(e){return Gn[e]>=128?"0xffff"+mn[Gn[e]]+mn[Gn[e+1]]:Gn[e]?"0x"+mn[Gn[e]]+mn[Gn[e+1]]:"0x"+mn[Gn[e+1]]}function z(e){return Gn[e]?"0x"+mn[Gn[e]]+mn[Gn[e+1]]+mn[Gn[e+2]]+mn[Gn[e+3]]:Gn[e+1]?"0x"+mn[Gn[e+1]]+mn[Gn[e+2]]+mn[Gn[e+3]]:Gn[e+2]?"0x"+mn[Gn[e+2]]+mn[Gn[e+3]]:"0x"+mn[Gn[e+3]]}function S(e){return 4294967295==e?255&pn.frame.valstack.pop():c(e)}function C(e,n){4294967295==e?pn.frame.valstack.push(255&n):p(e,n)}function G(e){return 4294967295==e?pn.frame.valstack.pop():d(e)}function N(e,n){4294967295==e?pn.frame.valstack.push(n):v(e,n)}function j(e,n){return 4294967295==e?pn.frame.valstack.pop():d(e+4*n)}function F(e,n,r){4294967295==e?pn.frame.valstack.push(r):v(e+4*n,r)}function L(e){pn.resumevalue=e}function A(e){return e<65536?String.fromCharCode(e):(e-=65536,String.fromCharCode(55296+(e>>10),56320+(1023&e)))}function E(e){if(e<256)return vn[e];if(e<65536){for(e=e.toString(16);e.length<4;)e="0"+e;return"\\u"+e}var n;return e-=65536,n=55296+(e>>10),e=56320+(1023&e),"\\u"+n.toString(16)+"\\u"+e.toString(16)}function W(e){return E(e.charCodeAt(0))}function T(e){return e=e.replace(gn,W),'"'+e+'"'}function q(e){var n,r;if(arguments.length>1){for(e+=" (",n=1;n<arguments.length;n++)r=arguments[n],r="number"==typeof r?r.toString(16):""+r,1!=n&&(e+=" "),e+=r;e+=")"}throw s(e),new Error(e)}function V(e,n,r,t){var s;return void 0===n&&(n="_func"),s=void 0===r?new Function("self",e):void 0===t?new Function("self",r,e):new Function("self",r,t,e)}function I(e,n,r,t){e?(this.funcaddr=e,this.startpc=n,this.functype=c(e)):(this.funcaddr=null,this.startpc=null,this.functype=null),this.pathaddrs={},this[0]={},this[1]={},this[2]={},this.locallen=null,this.localsformat=r,this.rawformat=t,this.localsindex=[];var s,a,o=0;for(s=0;s<this.localsformat.length;s++){var i=this.localsformat[s];if(4==i.size)for(;3&o;)o++;else if(2==i.size)for(;1&o;)o++;for(a=0;a<i.count;a++)this.localsindex.push({size:i.size,pos:o}),o+=i.size}for(;3&o;)o++;this.locallen=o}function R(e){var n;for(this.vmfunc=e,this.depth=null,this.framestart=null,this.framelen=null,this.valstack=[],this.localspos=null,this.localsindex=e.localsindex,this.locals=[],n=0;n<this.localsindex.length;n++){var r=this.localsindex[n];this.locals[r.pos]=0}this.framelen=8+e.rawformat.length+e.locallen}function D(e){var n=new R(e.vmfunc);return n.depth=e.depth,n.framestart=e.framestart,n.framelen=e.framelen,n.valstack=e.valstack.slice(0),n.localspos=e.localspos,n.locals=e.locals.slice(0),n.framelen=e.framelen,n}function O(e,n){_(n,e.framelen);var r=e.vmfunc.rawformat;_(n,8+r.length);for(var t=0;t<r.length;t++)n.push(r[t]);for(var t=0;t<e.vmfunc.localsindex.length;t++){var s=e.vmfunc.localsindex[t];if(4==s.size){for(;3&n.length;)n.push(0);_(n,e.locals[s.pos])}else if(2==s.size){for(;1&n.length;)n.push(0);w(n,e.locals[s.pos])}else k(n,e.locals[s.pos])}for(;3&n.length;)n.push(0);for(var t=0;t<e.valstack.length;t++)_(n,e.valstack[t])}function U(e){var n=i(e,e.length-4);if(n<0||n>=e.length)return void s("Bad frameptr in serialized stack frame");e=e.splice(n,e.length);for(var r=i(e,0),t=i(e,4),a=e.slice(8,t),o=[],c=8;;){var u=f(e,c);c++;var d=f(e,c);if(c++,0==u)break;1!=u&&2!=u&&4!=u&&q("Invalid local variable size in function header.",u),o.push({size:u,count:d})}var h=new I(null,null,o,a),p=new R(h);p.framestart=n;for(var m=0;m<p.vmfunc.localsindex.length;m++){var v=p.vmfunc.localsindex[m];4==v.size?p.locals[v.pos]=i(e,t+v.pos):2==v.size?p.locals[v.pos]=l(e,t+v.pos):p.locals[v.pos]=f(e,t+v.pos)}for(var g=r;g<e.length;g+=4)p.valstack.push(i(e,g));return p}function P(e,n){0==e&&q("Tried to create a VMTextEnv for address zero."),this.addr=e,this.cacheable=void 0!==n,this.decoding_tree=n,this.vmstring_tables=[],this.cacheable&&(this.vmstring_tables[0]={},this.vmstring_tables[1]={},this.vmstring_tables[2]={})}function B(){function e(e,n){this.argsize=n?n:4,this.numops=e.length;for(var r=[],t=0;t<e.length;t++)r.push(e.charAt(t));this.formlist=r}var n=new e(""),r=new e("L"),t=new e("LL"),s=new e("LLL"),a=new e("LLLL"),o=new e("LS"),i=new e("LLS"),l=new e("LLLLLLS"),f=new e("LLLLLLLS"),c=new e("LLSS"),u=new e("LC"),d=new e("LLC"),h=new e("LLLC"),p=new e("LLLLC"),m=new e("ES"),v=new e("LES"),g=new e("EES"),_=new e("F"),w=new e("LF"),k=new e("LLF"),b=new e("EF"),y=new e("EF",1),x=new e("EF",2),M=new e("S"),z=new e("SS"),S=new e("CL"),C=new e("C");_n={0:n,16:g,17:v,18:i,19:i,20:i,21:m,24:g,25:g,26:g,27:m,28:i,29:i,30:i,32:r,34:t,35:t,36:s,37:s,38:s,39:s,40:s,41:s,42:s,43:s,44:s,45:s,48:d,49:r,50:S,51:t,52:t,64:b,65:x,66:y,68:o,69:o,72:i,73:i,74:i,75:i,76:s,77:s,78:s,79:s,80:_,81:w,82:n,83:t,84:r,112:r,113:r,114:r,115:r,256:i,257:r,258:M,259:o,260:r,272:o,273:r,288:n,289:M,290:n,291:u,292:w,293:C,294:_,295:t,304:k,320:M,321:r,328:z,329:t,336:f,337:f,338:l,352:u,353:d,354:h,355:p,368:t,369:s,376:o,377:r,384:t,385:t,400:o,401:o,402:o,408:o,409:o,416:i,417:i,418:i,419:i,420:c,424:o,425:o,426:o,427:i,432:o,433:o,434:o,435:o,436:o,437:o,438:i,448:a,449:a,450:s,451:s,452:s,453:s,456:t,457:t}}function Q(e){if(0==e.mode)return"null";var n="m"+e.mode;if(null!=e.argsize&&(n=n+"s"+e.argsize),null!=e.addr&&(n=n+"a"+e.addr),pn.funcop_cache.key)return"self.funcop_cache."+n;var r={key:n,mode:e.mode,argsize:e.argsize,addr:e.addr};return pn.funcop_cache[n]=r,"self.funcop_cache."+n}function H(e,n,r){switch(n.mode){case 8:if(4==n.argsize){var t=r[0];if("0"===t)return void e.offstack.push(r);if("_"===t)return void te(e,r)}return holdvar=ne(e,!0),e.offstack.push(holdvar),void(4==n.argsize?e.code.push(holdvar+"=("+r+");"):2==n.argsize?e.code.push(holdvar+"=0xffff&("+r+");"):e.code.push(holdvar+"=0xff&("+r+");"));case 0:return void e.code.push("("+r+");");case 11:if(4==n.argsize){var t=r[0];if("0"===t)return void se(e,n.addr,r,!1);if("_"===t)return void se(e,n.addr,r,!0)}return se(e,n.addr,void 0),void(4==n.argsize?e.code.push("self.frame.locals["+n.addr+"]=("+r+");"):2==n.argsize?e.code.push("self.frame.locals["+n.addr+"]=(0xffff &"+r+");"):e.code.push("self.frame.locals["+n.addr+"]=(0xff &"+r+");"));case 15:return void(4==n.argsize?e.code.push("self.MemW4("+n.addr+","+r+");"):2==n.argsize?e.code.push("self.MemW2("+n.addr+","+r+");"):e.code.push("self.MemW1("+n.addr+","+r+");"));default:q("Unknown addressing mode in store func operand.")}}function Z(e,n,r){void 0===r&&(r=e.cp),e.code.push("self.frame.valstack.push("+n+","+r+",self.frame.framestart);")}function J(e){e.code.push("if (!substring) { substring=true;"),e.code.push("self.frame.valstack.push(0x11,0,nextcp,self.frame.framestart);"),e.code.push("}")}function $(e,n){var r;if(e.offstack.length&&e.code.push("self.frame.valstack.push("+e.offstack.join(",")+");"),e.offloc.length)for(r=0;r<e.offloc.length;r++)void 0!==e.offloc[r]&&e.offlocdirty[r]&&e.code.push("self.frame.locals["+r+"]="+e.offloc[r]+";");if(!n){var t;for(r=0;r<e.offloc.length;r++)t=e.offloc[r],void 0!==t&&void 0!==e.holduse[t]&&(e.holduse[t]=!1);for(e.offloc.length=0,e.offlocdirty.length=0;e.offstack.length;)t=e.offstack.pop(),void 0!==e.holduse[t]&&(e.holduse[t]=!1)}}function X(e){if(0!=e.buffer.length){var n=e.buffer.join("");e.buffer.length=0,e.code.push("Glk.glk_put_jstring("+T(n)+");")}}function Y(e,n,r){var t;if(oe(n))return t=Number(n),2147483648&t?""+(t-4294967296):n;if(t="("+n+"&0xffffffff)",r){var s=ne(e);return e.code.push(s+"="+t+";"),s}return t}function K(e,n,r){var t;if(oe(n))return t=Number(n),2147483648==t?"-0":""+We(t);if(t="self.decode_float("+n+")",r){var s=ne(e);return e.code.push(s+"="+t+";"),s}return t}function ee(e,n,r){if(oe(n)){var t=Number(n);if(0==t||1==t)r&&(e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0),e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+t+");");else{$(e,!r);var s=e.cp+t-2>>>0;e.code.push("self.pc = "+s+";"),e.vmfunc.pathaddrs[s]=!0}}else $(e,!r),e.code.push("if (("+n+")==0 || ("+n+")==1) {"),e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+n+");"),e.code.push("}"),e.code.push("else {"),e.code.push("self.pc = ("+e.cp+"+("+n+")-2) >>>0;"),e.code.push("}");e.code.push("return;")}function ne(e,n){for(var r,t=0;;){if(r="_hold"+t,!e.holduse[r])return e.holduse[r]=!n||1,r;t++}}function re(e){var n=e.offstack.pop();if(oe(n))return n;var r=e.holduse[n];return r--,0==r&&(r=!0),e.holduse[n]=r,n}function te(e,n){e.offstack.push(n);var r=e.holduse[n];r&&r!==!0?r++:r=1,e.holduse[n]=r}function se(e,n,r,t){var s=e.offloc[n];if(s&&ie(s)){var a=e.holduse[s];a--,0==a&&(a=!0),e.holduse[s]=a}if(void 0===r)return e.offloc[n]=void 0,void(e.offlocdirty[n]=!1);if(e.offloc[n]=r,e.offlocdirty[n]=!0,t){var o=r,a=e.holduse[o];a&&a!==!0?a++:a=1,e.holduse[o]=a}}function ae(e,n){for(var r;e.offstack.length<n;)r=ne(e,!0),e.offstack.unshift(r),e.code.push(r+"=self.frame.valstack.pop();")}function oe(e){return"0"===e[0]}function ie(e){return"_"===e[0]}function le(e,n,r,t){var s,a,o,i,l,f,h;for(t.desttype=0,t.numops=r.numops,s=n,n+=r.numops+1>>1,a=0;a<r.numops;a++){0==(1&a)?(o=c(s),i=15&o):(i=o>>4&15,s++);var p=r.formlist[a];if("L"!=p)if("E"!=p)if("S"!=p)if("F"!=p)if("C"!=p)q("Unknown operand type.",p);else{switch(i){case 8:t[a]="3,0";continue;case 0:t[a]="0,0";continue}if(i>=9&&i<=11){9==i?(f=c(n),n++):10==i?(f=u(n),n+=2):11==i&&(f=d(n),n+=4),t[a]="2,"+f;continue}switch(i){case 15:f=d(n)+In,n+=4;break;case 14:f=u(n)+In,n+=2;break;case 13:f=c(n)+In,n++;break;case 7:f=d(n),n+=4;break;case 6:f=u(n),n+=2;break;case 5:f=c(n),n++;break;default:q("Unknown addressing mode in store operand.")}t[a]="1,"+f}else{var m=t.func_store;switch(i){case 8:m.mode=8,m.argsize=r.argsize,t[a]=m;continue;case 0:m.mode=0,m.argsize=r.argsize,t[a]=m;continue}if(i>=9&&i<=11){9==i?(f=c(n),n++):10==i?(f=u(n),n+=2):11==i&&(f=d(n),n+=4),m.mode=11,m.addr=f,m.argsize=r.argsize,t[a]=m;continue}switch(i){case 15:f=d(n)+In,n+=4;break;case 14:f=u(n)+In,n+=2;break;case 13:f=c(n)+In,n++;break;case 7:f=d(n),n+=4;break;case 6:f=u(n),n+=2;break;case 5:f=c(n),n++;break;default:q("Unknown addressing mode in store operand.")}m.mode=15,m.addr=f,m.argsize=r.argsize,t[a]=m}else{switch(i){case 8:h=ne(e,!0),e.offstack.push(h),t[a]=h+"=(";continue;case 0:t[a]="(";continue}if(i>=9&&i<=11){9==i?(f=c(n),n++):10==i?(f=u(n),n+=2):11==i&&(f=d(n),n+=4),4==r.argsize?(h=ne(e,!0),se(e,f,h,!1),t[a]=h+"=("):2==r.argsize?(se(e,f,void 0),t[a]="self.frame.locals["+f+"]=(0xffff &"):(se(e,f,void 0),t[a]="self.frame.locals["+f+"]=(0xff &");continue}switch(i){case 15:f=d(n)+In,n+=4;break;case 14:f=u(n)+In,n+=2;break;case 13:f=c(n)+In,n++;break;case 7:f=d(n),n+=4;break;case 6:f=u(n),n+=2;break;case 5:f=c(n),n++;break;default:q("Unknown addressing mode in store operand.")}l=4==r.argsize?"self.MemW4("+f+",":2==r.argsize?"self.MemW2("+f+",":"self.MemW1("+f+",",t[a]=l}else{switch(i){case 8:e.offstack.length?t[a]=re(e):t[a]="self.frame.valstack.pop()";continue;case 0:t[a]="0";continue;case 1:l=x(n),n++,t[a]=l;continue;case 2:l=M(n),n+=2,t[a]=l;continue;case 3:l=z(n),n+=4,t[a]=l;continue}if(i>=9&&i<=11){if(9==i?(f=c(n),n++):10==i?(f=u(n),n+=2):11==i&&(f=d(n),n+=4),void 0!==e.offloc[f]){t[a]=e.offloc[f];continue}l=4==r.argsize?"self.frame.locals["+f+"]":2==r.argsize?"self.frame.locals["+f+"] & 0xffff":"self.frame.locals["+f+"] & 0xff",h=ne(e,!0),e.code.push(h+"=("+l+");"),e.offloc[f]=h,e.offlocdirty[f]=!1,t[a]=h;continue}switch(i){case 15:f=d(n)+In,n+=4;break;case 14:f=u(n)+In,n+=2;break;case 13:f=c(n)+In,n++;break;case 7:f=d(n),n+=4;break;case 6:f=u(n),n+=2;break;case 5:f=c(n),n++;break;default:q("Unknown addressing mode in load operand.")}l=4==r.argsize?"self.Mem4("+f+")":2==r.argsize?"self.Mem2("+f+")":"self.Mem1("+f+")",t[a]=l}else{switch(i){case 8:e.offstack.length?t[a]=re(e):(h=ne(e),e.code.push(h+"=self.frame.valstack.pop();"),t[a]=h);continue;case 0:t[a]="0";continue;case 1:l=x(n),n++,t[a]=l;continue;case 2:l=M(n),n+=2,t[a]=l;continue;case 3:l=z(n),n+=4,t[a]=l;continue}if(i>=9&&i<=11){if(9==i?(f=c(n),n++):10==i?(f=u(n),n+=2):11==i&&(f=d(n),n+=4),void 0!==e.offloc[f]){t[a]=e.offloc[f];continue}l=4==r.argsize?"self.frame.locals["+f+"]":2==r.argsize?"self.frame.locals["+f+"] & 0xffff":"self.frame.locals["+f+"] & 0xff",h=ne(e,!0),e.code.push(h+"=("+l+");"),e.offloc[f]=h,e.offlocdirty[f]=!1,t[a]=h;continue}switch(i){case 15:f=d(n)+In,n+=4;break;case 14:f=u(n)+In,n+=2;break;case 13:f=c(n)+In,n++;break;case 7:f=d(n),n+=4;break;case 6:f=u(n),n+=2;break;case 5:f=c(n),n++;break;default:q("Unknown addressing mode in load operand.")}l=4==r.argsize?"self.Mem4("+f+")":2==r.argsize?"self.Mem2("+f+")":"self.Mem1("+f+")",h=ne(e),e.code.push(h+"=("+l+");"),t[a]=h}}return n}function fe(e){var n=e,r=c(n);192!=r&&193!=r&&(r>=192&&r<=223?q("Call to unknown type of function.",n):q("Call to non-function.",n)),n++;for(var t=[],s=n;;){var a=c(n);n++;var o=c(n);if(n++,0==a)break;1!=a&&2!=a&&4!=a&&q("Invalid local variable size in function header.",a),t.push({size:a,count:o})}for(var i=Gn.slice(s,n);i.length%4;)i.push(0);return new I(e,n,t,i)}function ce(e,n,r){var t,s,a,o=n,i={vmfunc:e,cp:null,prevcp:null,curiosys:r,code:[],holduse:{},varsused:{},offstack:[],offloc:[],offlocdirty:[],path_ends:!1},l={};for(l.func_store={},i.code.push("");!i.path_ends;){i.prevcp=o,s=o,t=c(o),void 0===t&&q("Tried to compile nonexistent address",o),o++,128&t&&(64&t?(t&=63,t=256*t|c(o),o++,t=256*t|c(o),o++,t=256*t|c(o),o++):(t&=127,t=256*t|c(o),o++));var f=_n[t];f||q("Encountered unknown opcode.",t),o=le(i,o,f,l),i.cp=o;var u=wn[t];u||q("Encountered unhandled opcode.",t),u(i,l);for(a in i.holduse)i.holduse[a]===!0&&(i.holduse[a]=!1);e.pathaddrs[o]&&!i.path_ends&&(i.code.push("self.pc="+o+";"),$(i),i.code.push("return;"),i.path_ends=!0)}i.offstack.length&&q("Path compilation ended with nonempty offstack.",i.offstack.length),i.offloc.length&&q("Path compilation ended with nonempty offloc.",i.offloc.length);var d=[];for(a in i.holduse)d.push(a);for(a in i.varsused)d.push(a);return d.length&&(i.code[0]="var "+d.join(",")+";"),V(i.code.join("\n"),"_func_path_"+n)}function ue(e,n){var r;Xn++;var t=xn[e];if(void 0!==t){Yn++;var s=t(n,pn.tempcallargs);return void pe(s)}var a=Wn[e];void 0===a&&(a=fe(e),e<In&&(Wn[e]=a)),pn.pc=a.startpc;var o=new R(a);if(o.depth=Nn.length,0==Nn.length?o.framestart=0:o.framestart=pn.frame.framestart+pn.frame.framelen+4*pn.frame.valstack.length,Nn.push(o),pn.frame=o,192==a.functype){for(r=n-1;r>=0;r--)pn.frame.valstack.push(pn.tempcallargs[r]);pn.frame.valstack.push(n)}else for(r=0;r<n;r++){var i=a.localsindex[r];if(void 0===i)break;4==i.size?pn.frame.locals[i.pos]=pn.tempcallargs[r]:2==i.size?pn.frame.locals[i.pos]=65535&pn.tempcallargs[r]:1==i.size&&(pn.frame.locals[i.pos]=255&pn.tempcallargs[r])}}function de(){var e=pn.frame.depth;return Nn.pop(),0==Nn.length?(pn.frame=null,!0):(pn.frame=Nn[Nn.length-1],void(pn.frame.depth!=e-1&&q("Stack inconsistent after function exit.")))}function he(e){for(;Nn.length&&Nn[Nn.length-1].framestart>e;)Nn.pop();0==Nn.length&&q("Stack evaporated during throw."),pn.frame=Nn[Nn.length-1],e-=pn.frame.framestart+pn.frame.framelen,e<0&&q("Attempted to throw below the frame value stack."),3&e&&q("Attempted to throw to an unaligned address."),e>>>=2,e>pn.frame.valstack.length&&q("Attempted to throw beyond the frame value stack."),pn.frame.valstack.length=e}function pe(e){var n,r;isNaN(e)&&q("Function returned undefined value.");var t=pn.frame.valstack,s=t.length,a=t[s-1];switch(a!=pn.frame.framestart&&(t.length-=1,q("Call stub frameptr ("+a+") does not match frame ("+pn.frame.framestart+")")),pn.pc=t[s-2],n=t[s-3],r=t[s-4],t.length-=4,r){case 0:return;case 1:return void v(n,e);case 2:return void(pn.frame.locals[n]=e);case 3:return void pn.frame.valstack.push(e);case 17:return void q("String-terminator call stub at end of function call.");case 16:return void Ge(0,pn.pc,225,n);case 18:return void Ce(0,pn.pc,!0,n);case 19:return void Ge(0,pn.pc,224,n);case 20:return void Ge(0,pn.pc,226,n);default:q("Unrecognized desttype in callstub.",r)}}function me(e,n,r){switch(e){case 0:return;case 1:return void v(n,r);case 2:return void(pn.frame.locals[n]=r);case 3:return void pn.frame.valstack.push(r);default:q("Unrecognized desttype in callstub.",e)}}function ve(e,n){if(e)switch(e.mode){case 8:return void pn.frame.valstack.push(n);case 0:return;case 11:return void(4==e.argsize?pn.frame.locals[e.addr]=n:2==e.argsize?pn.frame.locals[e.addr]=65535&n:pn.frame.locals[e.addr]=255&n);case 15:return void(4==e.argsize?v(e.addr,n):2==e.argsize?m(e.addr,n):p(e.addr,n));default:q("Unknown addressing mode in store func by operand.")}}function ge(){var e=pn.prevpc,n=c(e);return e++,128&n&&(64&n?(n&=63,n=n<<8|c(e),e++,n=n<<8|c(e),e++,n=n<<8|c(e),e++):(n&=127,n=n<<8|c(e),e++)),304!=n?(s("parse_partial_operand: parsed wrong opcode: "+n),null):{selop:15&c(e),argsop:c(e)>>4&15,resop:15&c(e+1)}}function _e(e){0==e?pn.random_func=Math.random:(we(e),pn.random_func=ke)}function we(e){var n,r,t,s,a;for(void 0===yn&&(yn=Array(55)),yn[54]=e,kn=0,bn=31,t=1,n=0;n<55;n++)r=21*n%55,yn[r]=t,t=e-t>>>0,e=yn[r];for(a=0;a<4;a++)for(n=0;n<55;n++)s=yn[n]-yn[(1+n+30)%55],yn[n]=s>>>0}function ke(){return kn=(kn+1)%55,bn=(bn+1)%55,yn[kn]=yn[kn]-yn[bn]>>>0,yn[kn]/4294967296}function be(e){return d(e+13+zn[7])==zn[2]}function ye(e,n){var r,t=0;if(4294901760&n){if(t=d(zn[0]+4*(65535&n)),Cn[0]=e,Cn[1]=t,0==Sn[5](2,Cn))return 0;n>>=16,e=t}return Cn[0]=e,Cn[1]=n,r=Sn[2](2,Cn),0==r?0:be(e)&&0==t&&(n<zn[1]||n>=zn[1]+8)?0:d(zn[6])!=e&&1&c(r+9)?0:r}function xe(e,n){var r,t=0;if(4294901760&n){if(t=d(zn[0]+4*(65535&n)),Cn[0]=e,Cn[1]=t,0==Sn[11](2,Cn))return 0;n>>=16,e=t}return Cn[0]=e,Cn[1]=n,r=Sn[8](2,Cn),0==r?0:be(e)&&0==t&&(n<zn[1]||n>=zn[1]+8)?0:d(zn[6])!=e&&1&c(r+9)?0:r}function Me(e){if(pn.stringtable!=e&&(qn=void 0,Vn=void 0,pn.stringtable=e,0!=pn.stringtable)){var n=Tn[pn.stringtable];if(void 0===n){var r=void 0,t=d(pn.stringtable),s=d(pn.stringtable+8),a=pn.stringtable+t<=In;if(a){var o=Array(1);Se(o,s,4,0),r=o[0],void 0===r&&q("Failed to create decoding tree.")}n=new P(pn.stringtable,r),Tn[pn.stringtable]=n}qn=n.decoding_tree,Vn=n.vmstring_tables[pn.iosysmode]}}function ze(e,n){switch(e){case 0:n=0;break;case 1:break;case 2:n=0;break;default:e=0,n=0}pn.iosysmode=e,pn.iosysrock=n;var r=Tn[pn.stringtable];Vn=void 0===r?void 0:r.vmstring_tables[pn.iosysmode]}function Se(e,n,r,t){var s,a,o,i;if(a=c(n),0==a&&4==r)return o=Array(16),o.type=0,o.depth=4,e[t]=o,void Se(o,n,0,0);if(0==a){var l=d(n+1),f=d(n+5);return Se(e,l,r+1,t),void Se(e,f,r+1,t|1<<r)}switch(n++,o={},o.type=a,o.depth=r,a){case 2:o.value=c(n),o.cchar=A(o.value);break;case 4:o.value=d(n),o.cchar=A(o.value);break;case 3:case 5:o.addr=n;break;case 8:case 9:o.addr=d(n);break;case 10:case 11:o.addr=n;break;case 1:break;default:q("Unknown node type in string table.",a)}for(i=1<<r,s=t;s<16;s+=i)e[s]=o}function Ce(e,n,r,t){var s=(4294967295&n).toString(10);switch(pn.iosysmode){case 2:t&&(s=s.slice(t)),Glk.glk_put_jstring(s,!0);break;case 1:if(r||(pn.frame.valstack.push(17,0,e,pn.frame.framestart),r=!0),t<s.length){var a=s.charCodeAt(t);return pn.frame.valstack.push(18,t+1,n,pn.frame.framestart),pn.tempcallargs[0]=a,ue(pn.iosysrock,1),!0}break;case 0:}if(r){var o,i;pn.frame.valstack.pop()!=pn.frame.framestart&&q("Call stub frameptr does not match frame."),pn.pc=pn.frame.valstack.pop(),i=pn.frame.valstack.pop(),o=pn.frame.valstack.pop(),17!=o&&q("String-on-string call stub while printing number.")}}function Ge(e,n,r,t){for(var s,a,o,i,l,f=0!=r;;){if(a=void 0,s=0==r?n:n+"/"+r+"/"+t,void 0!==Vn&&n<In?(a=Vn[s],void 0===a&&(a=Ne(pn.iosysmode,n,r,t),Vn[s]=a,tr++,rr++)):(a=Ne(pn.iosysmode,n,r,t),tr++),a instanceof Function){if(o=a(pn,e,f),o instanceof Array){f=!0,n=o[0],r=o[1],t=o[2];continue}if(o)return!0}else if(Glk.glk_put_jstring(a),!f)return!1;if(pn.frame.valstack.pop()!=pn.frame.framestart&&q("Call stub frameptr does not match frame."),pn.pc=pn.frame.valstack.pop(),l=pn.frame.valstack.pop(),i=pn.frame.valstack.pop(),17==i)return!0;16==i?(f=!0,t=l,r=225,n=pn.pc):q("Function-terminator call stub at end of string.")}}function Ne(e,n,r,t){var s,a,o=n,i=t,l=void 0;o||q("Called compile_string with null address.");var f={startaddr:n,startbitnum:t,buffer:[],code:[]};if(0==r?(a=c(o),226==a?o+=4:o++,i=0):a=r,225==a)if(qn){var u,h,p,m,v,g,_=!1;for(u=c(o),i&&(u>>=i),h=8-i,p=!1,qn instanceof Array||(_=!0),v=qn;!_;){if(h<4){var w=c(o+1);u|=w<<h,h+=8,p=!0}if(g=v[15&u],h-=g.depth,u>>=g.depth,i+=g.depth,i>=8)if(o+=1,i-=8,p)p=!1;else{var w=c(o);u|=w<<h,h+=8}if(g instanceof Array)v=g;else switch(g.type){case 1:_=!0;break;case 2:case 4:switch(e){case 2:f.buffer.push(g.cchar);break;case 1:X(f),J(f),Z(f,"0x10,"+i,o),f.code.push("self.tempcallargs[0]="+g.value+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),l=!0,_=!0}v=qn;break;case 3:switch(e){case 2:for(m=g.addr;;){if(s=c(m),0==s)break;f.buffer.push(A(s)),m++}break;case 1:X(f),J(f),Z(f,"0x10,"+i,o),l="["+g.addr+", 0xE0, 0]",_=!0}v=qn;break;case 5:switch(e){case 2:for(m=g.addr;;){if(s=d(m),0==s)break;f.buffer.push(A(s)),m+=4}break;case 1:X(f),J(f),Z(f,"0x10,"+i,o),l="["+g.addr+", 0xE2, 0]",_=!0}v=qn;break;case 8:case 9:case 10:case 11:X(f),J(f),f.code.push("var otype, retval;"),f.code.push("var oaddr = "+g.addr+";"),g.type>=9&&f.code.push("oaddr = self.Mem4(oaddr);"),11==g.type&&f.code.push("oaddr = self.Mem4(oaddr);"),f.code.push("otype = self.Mem1(oaddr);"),l="retval",_=!0,Z(f,"0x10,"+i,o),f.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),f.code.push("retval = [oaddr, 0, 0];"),f.code.push("}"),f.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");var k=0;if(10==g.type||11==g.type){k=d(g.addr+4);for(var b=0;b<k;b++)f.code.push("self.tempcallargs["+b+"]="+d(g.addr+8+4*b)+";")}f.code.push("self.enter_function(oaddr, "+k+");"),f.code.push("retval = true;"),f.code.push("}"),f.code.push("else {"),f.code.push("self.fatal_error('Unknown object while decoding string indirect reference.', otype);"),f.code.push("}");break;default:q("Unknown entity in string decoding (cached).")}}}else{var y,x,M,_=!1;for(pn.stringtable||q("Attempted to print a compressed string with no table set."),x=c(o),i&&(x>>=i),y=d(pn.stringtable+8);!_;)switch(M=c(y),y++,M){case 0:y=d(1&x?y+4:y+0),7==i?(i=0,o++,x=c(o)):(i++,x>>=1);break;case 1:l=!1,_=!0;break;case 2:switch(s=c(y),e){case 2:f.buffer.push(A(s));break;case 1:X(f),J(f),Z(f,"0x10,"+i,o),f.code.push("self.tempcallargs[0]="+s+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),l=!0,_=!0}y=d(pn.stringtable+8);break;case 4:switch(s=d(y),e){case 2:f.buffer.push(A(s));break;case 1:X(f),J(f),Z(f,"0x10,"+i,o),f.code.push("self.tempcallargs[0]="+s+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),l=!0,_=!0}y=d(pn.stringtable+8);break;case 3:switch(e){case 2:for(;;){if(s=c(y),0==s)break;f.buffer.push(A(s)),y++}break;case 1:X(f),J(f),Z(f,"0x10,"+i,o),l="["+y+", 0xE0, 0]",_=!0}y=d(pn.stringtable+8);break;case 5:switch(e){case 2:for(;;){if(s=d(y),0==s)break;f.buffer.push(A(s)),y+=4}break;case 1:X(f),J(f),Z(f,"0x10,"+i,o),l="["+y+", 0xE2, 0]",_=!0}y=d(pn.stringtable+8);break;case 8:case 9:case 10:case 11:X(f),J(f),f.code.push("var otype, retval;"),f.code.push("var oaddr = "+d(y)+";"),9!=M&&11!=M||f.code.push("oaddr = self.Mem4(oaddr);"),f.code.push("otype = self.Mem1(oaddr);"),l="retval",_=!0,Z(f,"0x10,"+i,o),f.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),f.code.push("retval = [oaddr, 0, 0];"),f.code.push("}"),f.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");var k=0;if(10==M||11==M){k=d(y+4);for(var b=0;b<k;b++)f.code.push("self.tempcallargs["+b+"]="+d(y+8+4*b)+";")}f.code.push("self.enter_function(oaddr, "+k+");"),f.code.push("retval = true;"),f.code.push("}"),f.code.push("else {"),f.code.push("self.fatal_error('Unknown object while decoding string indirect reference.', otype);"),f.code.push("}");break;default:q("Unknown entity in string decoding.",M)}}else if(224==a){var s;switch(e){case 2:for(;;){if(s=c(o),o++,0==s)break;f.buffer.push(A(s))}break;case 1:X(f),J(f),s=c(o),o++,0!=s?(Z(f,"0x13,0",o),f.code.push("self.tempcallargs[0]="+s+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),l=!0):l="false"}}else if(226==a){var s;switch(e){case 2:for(;;){if(s=d(o),o+=4,0==s)break;f.buffer.push(A(s))}break;case 1:X(f),J(f),s=d(o),o+=4,0!=s?(Z(f,"0x14,0",o),f.code.push("self.tempcallargs[0]="+s+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),l=!0):l="false"}}else q(a>=224&&a<=255?"Attempt to print unknown type of string.":"Attempt to print non-string.");return l?(X(f),f.code.push("return "+l+";"),V(f.code.join("\n"),"_func_str_"+n,"nextcp","substring")):f.buffer.join("")}function je(e,n){switch(e){case 0:return 196866;case 1:return 131334;case 2:return 1;case 3:return 1;case 4:switch(n){case 0:return 1;case 1:return 1;case 2:return 1;default:return 0}break;case 5:return 1;case 6:return 1;case 7:return 1;case 8:return sn();case 9:return 1;case 10:return Sn[n]?1:0;case 11:return 1;default:return 0}}function Fe(e,n,r){if(1&r)return h(e,n);switch(n){case 4:return[e>>24&255,e>>16&255,e>>8&255,255&e];case 2:return[e>>8&255,255&e];case 1:return[255&e];default:q("Direct search key must hold one, two, or four bytes.")}}function Le(e,n,r,t,s,a,o){var i,l,f,c,u=0!=(4&o),d=0!=(2&o),p=Fe(e,n,o);for(l=0;l<s;l++,r+=t){for(f=!0,c=h(r+a,n),i=0;f&&i<n;i++)c[i]!=p[i]&&(f=!1);if(f)return u?l:r;if(d){for(f=!0,c=h(r+a,n),i=0;f&&i<n;i++)0!=c[i]&&(f=!1);if(f)break}}return u?4294967295:0}function Ae(e,n,r,t,s,a,o){var i,l,f,u,d,h,p,m,v=0!=(4&o),g=Fe(e,n,o);for(l=0,i=s;l<i;){for(d=0,u=i+l>>1,f=r+u*t,h=0;!d&&h<n;h++)p=c(f+a+h),m=g[h],p<m?d=-1:p>m&&(d=1);if(!d)return v?u:f;d<0?l=u+1:i=u}return v?4294967295:0}function Ee(e,n,r,t,s,a){for(var o,i,l,f=0!=(2&a),u=Fe(e,n,a);0!=r;){for(l=!0,o=0;l&&o<n;o++)i=c(r+t+o),i!=u[o]&&(l=!1);if(l)return r;if(f){for(l=!0,o=0;l&&o<n;o++)i=c(r+t+o),0!=i&&(l=!1);if(l)break}r=d(r+s)}return 0}function We(e){var n,r,t;return 2147483648&e?(n=!0,e=2147483647&e):n=!1,0==e?n?-0:0:2139095040==(2139095040&e)?0==(8388607&e)?n?-(1/0):1/0:NaN:(t=e>>23&255,r=t?(8388607&e|8388608)/8388608*Math.pow(2,t-127):(8388607&e)/8388608*Math.pow(2,-126),n?-r:r)}function Te(e){var n,r,t,s,a;return isNaN(e)?2139095041:isFinite(e)?0==e?1/e<0?2147483648:0:(e<0?(a=!0,n=-e):(a=!1,n=e),s=Math.floor(Math.log(n)/Math.log(2)),t=n/Math.pow(2,s),s>=128?a?4286578688:2139095040:(s<-126?(t*=Math.pow(2,126+s),s=0):0==s&&0==t||(s+=127,t-=1),t=8388608*t,r=t+.4999999999999999<<0,r>=8388608&&(r=0,s++,s>=255)?a?4286578688:2139095040:a?(2147483648|s<<23|r)>>>0:s<<23|r)):e<0?4286578688:2139095040}function qe(){var e,n;if(jn||q("There is no Glulx game file loaded."),pn.vm_started=!0,pn.resumefuncop=null,pn.resumevalue=0,Gn=null,Nn=[],pn.frame=null,pn.pc=0,pn.prevpc=0,jn.length<36&&q("This is too short to be a valid Glulx file."),e=i(jn,0),1198290284!=e&&q("This is not a valid Glulx file."),n=i(jn,4),n<131072&&q("This Glulx file is too old a version to execute."),n>=197120&&q("This Glulx file is too new a version to execute."),In=i(jn,8),Rn=i(jn,12),Dn=i(jn,16),On=i(jn,20),Un=i(jn,24),Pn=i(jn,28),Bn=i(jn,32),pn.protectstart=0,pn.protectend=0,(In<256||Rn<In||Dn<Rn)&&q("The segment boundaries in the header are in an impossible order."),Rn!=jn.length&&q("The game file length does not agree with the header."),pn.done_executing=!1,Wn={},Tn={},qn=void 0,Vn=void 0,pn.tempcallargs=Array(8),pn.tempglkargs=Array(8),_e(0),pn.endmem=Dn,pn.stringtable=0,Qn=[],Hn=0,Zn=[],Jn=[],En&&Dialog.autosave_write(Fn,null),An&&!En)try{var r=Dialog.autosave_read(Fn);if(r)return s("Found autosave..."),void Qe(r)}catch(e){s("Autorestore failed, deleting it: "+t(e)),e.stack&&s("JS stack dump:\n"+e.stack),Dialog.autosave_write(Fn,null)}Ve()}function Ve(){rn();var e=$e();Gn=null,Gn=jn.slice(0,Rn),pn.endmem=Gn.length,Je(Dn,!1),Xe(e),Nn=[],pn.frame=null,pn.pc=0,pn.prevpc=0,pn.iosysmode=0,pn.iosysrock=0,Me(Pn),ue(Un,0)}function Ie(e){result=[];for(var n=0;n<e.length;){for(var r=0;n<e.length&&0==e[n]&&r<=255;)r++,n++;for(r>0&&(result.push(0),result.push(r-1));n<e.length&&0!=e[n];)result.push(e[n]),n++}return result}function Re(e){result=[];for(var n=0;n<e.length;){var r=e[n++];if(0==r)for(var t=e[n++]+1,s=0;s<t;s++)result.push(0);else result.push(r)}return result}function De(e){bytes=[];for(var n=0;n<e.length;n++){var r=e[n].key,t=e[n].chunk;4!=r.length&&q("Bad chunk ID (must be exactly 4 chars): "+r),void 0==t&&q("Missing chunk data: "+r),g(bytes,r),_(bytes,t.length),bytes=bytes.concat(t),1&bytes.length&&bytes.push(0)}return bytes}function Oe(e){chunks={};for(var n=0;n<e.length;){if(n+8>e.length)return void s("IFF chunk header is truncated");var r=y(e,n,4),t=i(e,n+4);if(n+=8,n+t>e.length)return void s(r+" chunk is truncated ("+t+" bytes needed, "+(e.length-n)+" available");chunks[r]=e.slice(n,n+t),n+=t,1&n&&(n+=1)}return chunks}function Ue(e){2!=pn.iosysmode&&q("Streams are only available in Glk I/O system.");var n=GiDispa.class_obj_from_id("stream",e);if(!n)return!1;chunks=[],chunks.push({key:"IFhd",chunk:jn.slice(0,128)});for(var r=Gn.slice(In),t=In;t<jn.length;t++)r[t-In]^=jn[t];r=Ie(r),r.splice(0,0,0,0,0,0),b(r,0,pn.endmem),chunks.push({key:"CMem",chunk:r});var s=[];chunks.push({key:"Stks",chunk:s});for(var t=0;t<Nn.length;t++)O(Nn[t],s);if(tn()){var a=[];chunks.push({key:"MAll",chunk:a}),_(a,Hn),_(a,Zn.length);for(var t=0;t<Zn.length;t++)_(a,Zn[t].addr),_(a,Zn[t].size)}var o=[];g(o,"IFZS"),o=o.concat(De(chunks));var i=De([{key:"FORM",chunk:o}]);return Glk.glk_put_buffer_stream(n,i),!0}function Pe(e){2!=pn.iosysmode&&q("Streams are only available in Glk I/O system.");var n=GiDispa.class_obj_from_id("stream",e);if(!n)return!1;for(var r=new Array(0),t=new Array(1024),a=1;a>0;)a=Glk.glk_get_buffer_stream(n,t),r=r.concat(t.slice(0,a));if(r=Oe(r),!r)return s("vm_restore failed: file is not Quetzal"),
!1;if(r=r.FORM,!r||"IFZS"!=y(r,0,4))return s("vm_restore failed: file doesn't start with FORM/IFZS header"),!1;var o=Oe(r.slice(4));if(!o.IFhd)return s("vm_restore failed: missing required IFhd chunk"),!1;for(var l=0;l<128;l++)if(o.IFhd[l]!=jn[l])return s("vm_restore failed: this save image is for a different game"),!1;if(!o.CMem)return s("vm_restore failed: missing required CMem chunk"),!1;if(!o.Stks)return s("vm_restore failed: missing required Stks chunk"),!1;var f=$e();rn();var c=i(o.CMem,0),u=o.CMem.slice(4);for(u=Re(u);u.length<c-In;)u.push(0);Je(c,!1),Gn=jn.slice(0,In).concat(u);for(var l=In;l<jn.length;l++)Gn[l]^=jn[l];var d=o.Stks;for(Nn=[];d.length;)pn.frame=U(d),pn.frame||q("vm_restore failed: bad stack frame"),Nn.unshift(pn.frame);for(var l=0;l<Nn.length;l++)Nn[l].depth=l;pn.frame=Nn[Nn.length-1];var h=o.MAll;if(h&&h.length>=8){Hn=i(h,0);for(var p=i(h,4),l=0;l<p;l++){var m=i(h,8+8*l),v=i(h,12+8*l);Zn.push(new an(m,v))}Zn.sort(function(e,n){return e.addr-n.addr});for(var g=Hn,l=0;l<Zn.length;l++){var m=Zn[l].addr,v=Zn[l].size;(m<g||m+v>pn.endmem)&&q("vm_restore failed: corrupt dynamic heap"),m>g&&Jn.push(new an(g,m-g)),g=m+v}g<pn.endmem&&Jn.push(new an(g,pn.endmem-g))}return Xe(f),!0}function Be(e){if(e<0)return void Dialog.autosave_write(Fn,null);var n=ge();if(n){var r={},t=pn.frame.valstack,s=t.length;t.push(e),8==n.argsop&&t.push(1),8==n.selop&&t.push(192),t.push(0,0,pn.prevpc,pn.frame.framestart),r.ram=Gn.slice(In),r.endmem=pn.endmem,r.pc=pn.pc,r.stack=[];for(var a=0;a<Nn.length;a++)O(Nn[a],r.stack);if(tn()){r.heapstart=Hn,r.usedlist=[];for(var a=0;a<Zn.length;a++)r.usedlist.push(Zn[a].addr),r.usedlist.push(Zn[a].size)}t.length=s,r.stringtable=pn.stringtable,r.iosysmode=pn.iosysmode,r.iosysrock=pn.iosysrock,r.protectstart=pn.protectstart,r.protectend=pn.protectend,pn.random_func==ke&&yn&&(r.srand_table=yn.slice(0),r.srand_index1=kn,r.srand_index2=bn),r.accel_params=zn.slice(0),r.accel_funcnum_map={};for(var o in Mn)r.accel_funcnum_map[o]=Mn[o];r.glk=Glk.save_allstate(),Dialog.autosave_write(Fn,r)}}function Qe(e){Gn=jn.slice(0,Rn),Gn=Gn.slice(0,In).concat(e.ram),pn.endmem=e.endmem,pn.pc=e.pc,Nn=[];for(var n=e.stack.slice(0);n.length;){var r=U(n);r||q("vm_autorestore failed: bad stack frame"),Nn.unshift(r)}for(var t=0;t<Nn.length;t++)Nn[t].depth=t;if(pn.frame=Nn[Nn.length-1],void 0===e.heapstart)Hn=0,Zn=[],Jn=[];else{Hn=e.heapstart,Zn=[];for(var s=0;s<e.usedlist.length;s+=2){var a=e.usedlist[s],o=e.usedlist[s+1];Zn.push(new an(a,o))}Zn.sort(function(e,n){return e.addr-n.addr}),Jn=[];for(var i=Hn,t=0;t<Zn.length;t++){var a=Zn[t].addr,o=Zn[t].size;(a<i||a+o>pn.endmem)&&q("vm_autorestore failed: corrupt dynamic heap"),a>i&&Jn.push(new an(i,a-i)),i=a+o}i<pn.endmem&&Jn.push(new an(i,pn.endmem-i))}Me(e.stringtable),ze(e.iosysmode,e.iosysrock),pn.protectstart=e.protectstart,pn.protectend=e.protectend,void 0===e.srand_table?_e(0):(_e(1),yn=e.srand_table.slice(0),kn=e.srand_index1,bn=e.srand_index2),zn=e.accel_params.slice(0);for(var s in e.accel_funcnum_map)Mn[s]=e.accel_funcnum_map[s],xn[s]=pn.accel_func_map[Mn[s]];Glk.restore_allstate(e.glk),pe(0)}function He(){var e={};e.ram=Gn.slice(In),e.endmem=pn.endmem,e.pc=pn.pc,e.stack=[];for(var n=0;n<Nn.length;n++)e.stack[n]=D(Nn[n]);e.heapstart=Hn,e.usedlist=Zn.slice(0),e.freelist=Jn.slice(0),Qn.push(e),Qn.length>10&&Qn.shift()}function Ze(){if(0==Qn.length)return!1;var e=Qn.pop(),n=$e();return Gn=Gn.slice(0,In).concat(e.ram),pn.endmem=e.endmem,Nn=e.stack,pn.frame=Nn[Nn.length-1],pn.pc=e.pc,Hn=e.heapstart,Zn=e.usedlist,Jn=e.freelist,Xe(n),!0}function Je(e,n){var r;if(e!=pn.endmem){if(!n&&tn()&&q("Cannot resize Glulx memory space while heap is active."),e<Dn&&q("Cannot resize Glulx memory space smaller than it started."),255&e&&q("Can only resize Glulx memory space to a 256-byte boundary."),Gn.length=e,e>pn.endmem)for(r=pn.endmem;r<e;r++)Gn[r]=0;pn.endmem=e}}function $e(){if(pn.protectstart>=pn.protectend)return null;for(var e=pn.protectend-pn.protectstart,n={start:pn.protectstart,end:pn.protectend,len:e},r=Gn.slice(pn.protectstart,pn.protectend);r.length<e;)r.push(0);return n.mem=r,n}function Xe(e){if(e){var n,r,t=e.mem,s=e.start,a=e.end;for(a>pn.endmem&&(a=pn.endmem),n=0,r=s;r<a;n++,r++)Gn[r]=t[n]}}function Ye(){var e,n,r,t=jn.length;if(t<256||0!=(255&t))return 1;if(t!=i(jn,12))return 1;for(r=i(jn,32),n=-r>>>0,e=0;e<t;e+=4)n=n+i(jn,e)>>>0;return n!=r?1:0}function Ke(){return Fn}function en(){return pn}function nn(){var e={game_image_length:jn.length,total_execution_time:$n,total_function_calls:Xn,accel_function_calls:Yn,total_path_calls:Kn,paths_cached:er,paths_compiled:nr,strings_cached:rr,strings_compiled:tr};return e}function rn(){Hn=0,Zn=[],Jn=[]}function tn(){return Zn.length>0}function sn(){return Hn}function an(e,n){this.addr=e,this.size=n,this.end=e+n}function on(e,n){for(var r=0,t=e.length;r<t;){var s=r+t>>1;e[s].addr<n?r=s+1:t=s}return r}function ln(e){tn()||(Hn=pn.endmem);for(var n=0,r=Jn.length;n<r;n++){var t=Jn[n];if(t.size>=e){t.size>e?Jn[n]=new an(t.addr+e,t.size-e):Jn.splice(n,1);var s=on(Zn,t.addr);return Zn.splice(s,0,new an(t.addr,e)),t.addr}}var a=pn.endmem,o=e+255&4294967040;return Je(pn.endmem+o,!0),o>e&&Jn.push(new an(a+e,o-e)),Zn.push(new an(a,e)),a}function fn(e){var n=on(Zn,e),r=Zn[n];if(r&&r.addr==e||q("Tried to free non-existent block"),Zn.splice(n,1),0==Zn.length)return Je(Hn,!0),void rn();n=on(Jn,e);var t=Jn[n];t&&t.addr==r.end&&(r=new an(e,r.size+t.size),Jn.splice(n,1));var s=Jn[n-1];s&&s.end==r.addr&&(r=new an(s.addr,s.size+r.size),Jn.splice(n-1,1),n-=1),Jn.splice(n,0,r)}function cn(){if(!tn())return 0!=Hn&&q("Heap inconsistency: heapstart nonzero"),Zn.length>0&&q("Heap inconsistency: usedlist nonempty"),void(Jn.length>0&&q("Heap inconsistency: usedlist nonempty"));0==Hn&&q("Heap inconsistency: heapstart is zero");for(var e=Hn,n=0,r=0;n<Zn.length||r<Jn.length;){var t=Zn[n],s=Jn[r];t&&t.addr==e?(e+=t.size,n++):s&&s.addr==e?(e+=s.size,r++):q("Heap inconsistency: no block at address "+e)}e!=pn.endmem&&q("Heap inconsistency: overrun at end of heap")}function un(){return sr}function dn(){var e=GiLoad.get_debug_info();if(e){var n,r,t;if(222!=e[0]||191!=e[1]||0!=e[2]||0!=e[3])return void s("Dbug chunk did not contain an (old-style) Inform gameinfo.dbg file");e[4]<<8|e[5];for(r=6,n=!1;!n;){var a=e[r++];switch(a){case 0:case void 0:n=!0;break;case 1:e[r++];for(t=r;e[r];)r++;String.fromCharCode.apply(this,e.slice(t,r));for(r++,t=r;e[r];)r++;String.fromCharCode.apply(this,e.slice(t,r));r++;break;case 2:for(t=r;e[r];)r++;String.fromCharCode.apply(this,e.slice(t,r));r++;e.slice(r,r+4);r+=4;e.slice(r,r+4);r+=4;break;case 3:e[r++]<<8|e[r++];for(t=r;e[r];)r++;String.fromCharCode.apply(this,e.slice(t,r));r++;e.slice(r,r+4);r+=4;e.slice(r,r+4);r+=4;break;case 4:e[r++];for(t=r;e[r];)r++;var o=String.fromCharCode.apply(this,e.slice(t,r));r++;break;case 5:e[r++]<<8|e[r++];for(t=r;e[r];)r++;var o=String.fromCharCode.apply(this,e.slice(t,r));r++;break;case 6:e[r++]<<8|e[r++];for(t=r;e[r];)r++;var o=String.fromCharCode.apply(this,e.slice(t,r));r++;break;case 7:e[r++]<<8|e[r++];for(t=r;e[r];)r++;var o=String.fromCharCode.apply(this,e.slice(t,r));r++;break;case 8:e[r++]<<8|e[r++];for(t=r;e[r];)r++;var o=String.fromCharCode.apply(this,e.slice(t,r));r++;break;case 9:r+=64;break;case 10:var i=e[r++]<<8|e[r++],l=e[r++]<<8|e[r++];r+=6*l;break;case 11:var i=e[r++]<<8|e[r++];e.slice(r,r+4);r+=4;var f=e[r++]<<16|e[r++]<<8|e[r++];for(t=r;e[r];)r++;var c=String.fromCharCode.apply(this,e.slice(t,r));r++;for(var u=[];e[r];){for(t=r;e[r];)r++;var d=String.fromCharCode.apply(this,e.slice(t,r));r++,u.push(d)}r++,sr.functions.push({num:i,name:c,addr:f,locals:u});break;case 12:e[r++]<<8|e[r++];for(t=r;e[r];)r++;var o=String.fromCharCode.apply(this,e.slice(t,r));r++;break;case 13:for(;e[r];){for(t=r;e[r];)r++;var o=String.fromCharCode.apply(this,e.slice(t,r));r++;var h=e[r++]<<16|e[r++]<<8|e[r++];sr.map[o]=h}r++;break;case 14:var i=e[r++]<<8|e[r++];e.slice(r,r+4);r+=4;e[r++]<<16|e[r++]<<8|e[r++];break;default:s("Unknown record type in debug data: "+a),n=!0}}var p=sr.map["code area"];if(p){var m;for(m=0;m<sr.functions.length;m++){var v=sr.functions[m];sr.functionmap[p+v.addr]=v}}}}function hn(){var e,n,r,t,a;for(pn.resumefuncop&&(ve(pn.resumefuncop,pn.resumevalue),pn.resumefuncop=null,pn.resumevalue=0),t=(new Date).getTime();!pn.done_executing;){e=pn.frame.vmfunc,n=e[pn.iosysmode],r=n[pn.pc],void 0===r&&(e.pathaddrs[pn.pc]=!0,r=ce(e,pn.pc,pn.iosysmode),nr++,pn.pc<In&&(n[pn.pc]=r,er++)),Kn++;var o=r(pn);o===pn.VMStopped&&(pn.done_executing=!0,pn.vm_stopped=!0)}a=(new Date).getTime(),$n+=(a-t)/1e3,pn.vm_stopped&&Glk.glk_exit(),Glk.update(),s("### done executing; path time = "+(a-t)+" ms")}var pn={};void 0===Math.imul&&(s("Polyfilling Math.imul()."),Math.imul=function(e,n){var r=e>>>16&65535,t=65535&e,s=n>>>16&65535,a=65535&n;return t*a+(r*a+t*s<<16>>>0)|0});var mn=Array(256),vn=Array(256);pn.Mem1=c,pn.Mem2=u,pn.Mem4=d,pn.MemSlice=h,pn.MemW1=p,pn.MemW2=m,pn.MemW4=v;var gn=/[^a-zA-Z0-9 .,;:?!=_+()-]/g;pn.fatal_error=q;var _n=null;pn.funcop_cache={};var wn={0:function(e,n){},16:function(e,n){e.code.push(n[2]+"(("+n[0]+")+("+n[1]+")) >>>0);")},17:function(e,n){e.code.push(n[2]+"(("+n[0]+")-("+n[1]+")) >>>0);")},18:function(e,n){var r=Y(e,n[0]),t=Y(e,n[1]);e.code.push(n[2]+"(Math.imul(("+r+"),("+t+"))) >>>0);")},19:function(e,n){var r=Y(e,n[0]),t=Y(e,n[1]),s=ne(e);e.code.push(s+"=(("+r+")/("+t+"));"),e.code.push("if (!isFinite("+s+")) self.fatal_error('Division by zero.');"),e.code.push(n[2]+"("+s+">=0)?Math.floor("+s+"):(-Math.floor(-"+s+") >>>0));")},20:function(e,n){var r=Y(e,n[0]),t=Y(e,n[1]),s=ne(e);e.code.push(s+"=(("+r+")%("+t+"));"),e.code.push("if (!isFinite("+s+")) self.fatal_error('Modulo division by zero.');"),e.code.push(n[2]+s+" >>>0);")},21:function(e,n){e.code.push(n[1]+"(-("+n[0]+")) >>>0);")},24:function(e,n){e.code.push(n[2]+"(("+n[0]+")&("+n[1]+")) >>>0);")},25:function(e,n){e.code.push(n[2]+"(("+n[0]+")|("+n[1]+")) >>>0);")},26:function(e,n){e.code.push(n[2]+"(("+n[0]+")^("+n[1]+")) >>>0);")},27:function(e,n){e.code.push(n[1]+"(~("+n[0]+")) >>>0);")},28:function(e,n){if(oe(n[1])){var r=Number(n[1]);r<32?e.code.push(n[2]+"(("+n[0]+")<<"+r+") >>>0);"):e.code.push(n[2]+"0);")}else e.code.push(n[2]+"("+n[1]+"<32) ? (("+n[0]+"<<"+n[1]+") >>>0) : 0);")},29:function(e,n){if(oe(n[1])){var r=Number(n[1]);r<32?e.code.push(n[2]+"(("+n[0]+")>>"+r+") >>>0);"):e.code.push(n[2]+"(("+n[0]+")&0x80000000) ? 0xffffffff : 0);")}else e.code.push("if ("+n[0]+" & 0x80000000) {"),e.code.push(n[2]+"("+n[1]+"<32) ? (("+n[0]+">>"+n[1]+") >>>0) : 0xffffffff);"),e.code.push("} else {"),e.code.push(n[2]+"("+n[1]+"<32) ? (("+n[0]+">>"+n[1]+") >>>0) : 0);"),e.code.push("}")},30:function(e,n){if(oe(n[1])){var r=Number(n[1]);r<32?e.code.push(n[2]+"("+n[0]+")>>>"+r+");"):e.code.push(n[2]+"0);")}else e.code.push(n[2]+"("+n[1]+"<32) ? ("+n[0]+">>>"+n[1]+") : 0);")},32:function(e,n){ee(e,n[0],!0),e.path_ends=!0},260:function(e,n){if(oe(n[0])){var r=Number(n[0]);e.code.push("self.pc = "+r+";"),e.vmfunc.pathaddrs[r]=!0}else e.code.push("self.pc = "+n[0]+";");$(e),e.code.push("return;"),e.path_ends=!0},34:function(e,n){e.code.push("if (("+n[0]+")==0) {"),ee(e,n[1]),e.code.push("}")},35:function(e,n){e.code.push("if (("+n[0]+")!=0) {"),ee(e,n[1]),e.code.push("}")},36:function(e,n){e.code.push("if (("+n[0]+")==("+n[1]+")) {"),ee(e,n[2]),e.code.push("}")},37:function(e,n){e.code.push("if (("+n[0]+")!=("+n[1]+")) {"),ee(e,n[2]),e.code.push("}")},38:function(e,n){var r=Y(e,n[0]),t=Y(e,n[1]);e.code.push("if (("+r+")<("+t+")) {"),ee(e,n[2]),e.code.push("}")},39:function(e,n){var r=Y(e,n[0]),t=Y(e,n[1]);e.code.push("if (("+r+")>=("+t+")) {"),ee(e,n[2]),e.code.push("}")},40:function(e,n){var r=Y(e,n[0]),t=Y(e,n[1]);e.code.push("if (("+r+")>("+t+")) {"),ee(e,n[2]),e.code.push("}")},41:function(e,n){var r=Y(e,n[0]),t=Y(e,n[1]);e.code.push("if (("+r+")<=("+t+")) {"),ee(e,n[2]),e.code.push("}")},42:function(e,n){e.code.push("if (("+n[0]+")<("+n[1]+")) {"),ee(e,n[2]),e.code.push("}")},43:function(e,n){e.code.push("if (("+n[0]+")>=("+n[1]+")) {"),ee(e,n[2]),e.code.push("}")},44:function(e,n){e.code.push("if (("+n[0]+")>("+n[1]+")) {"),ee(e,n[2]),e.code.push("}")},45:function(e,n){e.code.push("if (("+n[0]+")<=("+n[1]+")) {"),ee(e,n[2]),e.code.push("}")},48:function(e,n){if(oe(n[1])){var r,t=Number(n[1]);for(r=0;r<t;r++)if(e.offstack.length){var s=re(e);e.code.push("self.tempcallargs["+r+"]="+s+";")}else e.code.push("self.tempcallargs["+r+"]=self.frame.valstack.pop();");$(e)}else e.varsused.ix=!0,$(e),e.code.push("for (ix=0; ix<"+n[1]+"; ix++) { self.tempcallargs[ix]=self.frame.valstack.pop(); }");Z(e,n[2]),e.code.push("self.enter_function("+n[0]+", "+n[1]+");"),e.code.push("return;"),e.path_ends=!0},52:function(e,n){if(oe(n[1])){var r,t=Number(n[1]);for(r=0;r<t;r++)if(e.offstack.length){var s=re(e);e.code.push("self.tempcallargs["+r+"]="+s+";")}else e.code.push("self.tempcallargs["+r+"]=self.frame.valstack.pop();");$(e)}else e.varsused.ix=!0,$(e),e.code.push("for (ix=0; ix<"+n[1]+"; ix++) { self.tempcallargs[ix]=self.frame.valstack.pop(); }");e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.enter_function("+n[0]+", "+n[1]+");"),e.code.push("return;"),e.path_ends=!0},352:function(e,n){$(e),Z(e,n[1]),e.code.push("self.enter_function("+n[0]+", 0);"),e.code.push("return;"),e.path_ends=!0},353:function(e,n){$(e),e.code.push("self.tempcallargs[0]=("+n[1]+");"),Z(e,n[2]),e.code.push("self.enter_function("+n[0]+", 1);"),e.code.push("return;"),e.path_ends=!0},354:function(e,n){$(e),e.code.push("self.tempcallargs[0]=("+n[1]+");"),e.code.push("self.tempcallargs[1]=("+n[2]+");"),Z(e,n[3]),e.code.push("self.enter_function("+n[0]+", 2);"),e.code.push("return;"),e.path_ends=!0},355:function(e,n){$(e),e.code.push("self.tempcallargs[0]=("+n[1]+");"),e.code.push("self.tempcallargs[1]=("+n[2]+");"),e.code.push("self.tempcallargs[2]=("+n[3]+");"),Z(e,n[4]),e.code.push("self.enter_function("+n[0]+", 3);"),e.code.push("return;"),e.path_ends=!0},49:function(e,n){e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+n[0]+");"),e.code.push("return;"),e.path_ends=!0},50:function(e,n){$(e),Z(e,n[0]),e.code.push("self.store_operand("+n[0]+",self.frame.framestart+self.frame.framelen+4*self.frame.valstack.length);"),ee(e,n[1],!0),e.path_ends=!0},51:function(e,n){e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("self.pop_stack_to("+n[1]+");"),e.code.push("self.pop_callstub("+n[0]+");"),e.code.push("return;"),e.path_ends=!0},64:function(e,n){H(e,n[1],n[0])},65:function(e,n){H(e,n[1],n[0])},66:function(e,n){H(e,n[1],n[0])},68:function(e,n){var r;oe(n[0])?(r=Number(n[0]),r=32768&r?(4294901760|r)>>>0:65535&r,e.code.push(n[1]+r+");")):e.code.push(n[1]+"("+n[0]+" & 0x8000) ? (("+n[0]+" | 0xffff0000) >>> 0) : ("+n[0]+" & 0xffff));")},69:function(e,n){var r;oe(n[0])?(r=Number(n[0]),r=128&r?(4294967040|r)>>>0:255&r,e.code.push(n[1]+r+");")):e.code.push(n[1]+"("+n[0]+" & 0x80) ? (("+n[0]+" | 0xffffff00) >>> 0) : ("+n[0]+" & 0xff));")},72:function(e,n){var r,t;if(oe(n[1]))if(oe(n[0]))t=Number(n[0])+4*Number(n[1]),r="self.Mem4("+(t>>>0)+")";else{var t=4*Number(n[1]);r=t?"self.Mem4(("+n[0]+"+"+t+") >>>0)":"self.Mem4("+n[0]+")"}else r="self.Mem4(("+n[0]+"+4*"+n[1]+") >>>0)";e.code.push(n[2]+r+");")},73:function(e,n){var r,t;if(oe(n[1]))if(oe(n[0]))t=Number(n[0])+2*Number(n[1]),r="self.Mem2("+(t>>>0)+")";else{var t=2*Number(n[1]);r=t?"self.Mem2(("+n[0]+"+"+t+") >>>0)":"self.Mem2("+n[0]+")"}else r="self.Mem2(("+n[0]+"+2*"+n[1]+") >>>0)";e.code.push(n[2]+r+");")},74:function(e,n){var r,t;if(oe(n[1]))if(oe(n[0]))t=Number(n[0])+Number(n[1]),r="self.Mem1("+(t>>>0)+")";else{var t=Number(n[1]);r=t?"self.Mem1(("+n[0]+"+"+t+") >>>0)":"self.Mem1("+n[0]+")"}else r="self.Mem1(("+n[0]+"+"+n[1]+") >>>0)";e.code.push(n[2]+r+");")},76:function(e,n){var r,t;if(oe(n[1]))if(oe(n[0]))t=Number(n[0])+4*Number(n[1]),r=(t>>>0)+",";else{var t=4*Number(n[1]);r=t?"("+n[0]+"+"+t+") >>>0,":n[0]+","}else r="("+n[0]+"+4*"+n[1]+") >>>0,";e.code.push("self.MemW4("+r+n[2]+");")},77:function(e,n){var r,t;if(oe(n[1]))if(oe(n[0]))t=Number(n[0])+2*Number(n[1]),r=(t>>>0)+",";else{var t=2*Number(n[1]);r=t?"("+n[0]+"+"+t+") >>>0,":n[0]+","}else r="("+n[0]+"+2*"+n[1]+") >>>0,";e.code.push("self.MemW2("+r+n[2]+");")},78:function(e,n){var r,t;if(oe(n[1]))if(oe(n[0]))t=Number(n[0])+Number(n[1]),r=(t>>>0)+",";else{var t=Number(n[1]);r=t?"("+n[0]+"+"+t+") >>>0,":n[0]+","}else r="("+n[0]+"+"+n[1]+") >>>0,";e.code.push("self.MemW1("+r+n[2]+");")},75:function(e,n){if(oe(n[1])){var r,t,s;s=4294967295&Number(n[1]),r=7&s,oe(n[0])?(t=Number(n[0]),s>=0?t+=s>>3:t-=1+(-1-s>>3)):t=s>=0?s<=7?n[0]:n[0]+"+"+(s>>3):n[0]+"-"+(1+(-1-s>>3)),e.code.push(n[2]+"(self.Mem1("+t+") & "+(1<<r)+")?1:0);")}else{e.varsused.bitx=!0,e.varsused.addrx=!0;var a=Y(e,n[1],!0);e.code.push("bitx = "+a+"&7;"),e.code.push("if ("+a+">=0) addrx = "+n[0]+" + ("+a+">>3);"),e.code.push("else addrx = "+n[0]+" - (1+((-1-("+a+"))>>3));"),e.code.push(n[2]+"(self.Mem1(addrx) & (1<<bitx))?1:0);")}},79:function(e,n){var r,t,s,a;if(oe(n[1]))a=4294967295&Number(n[1]),r=7&a,oe(n[0])?(t=Number(n[0]),a>=0?t+=a>>3:t-=1+(-1-a>>3)):t=a>=0?a<=7?n[0]:n[0]+"+"+(a>>3):n[0]+"-"+(1+(-1-a>>3)),s=1<<r;else{e.varsused.bitx=!0,e.varsused.addrx=!0;var o=Y(e,n[1],!0);e.code.push("bitx = "+o+"&7;"),e.code.push("if ("+o+">=0) addrx = "+n[0]+" + ("+o+">>3);"),e.code.push("else addrx = "+n[0]+" - (1+((-1-("+o+"))>>3));"),t="addrx",s="(1<<bitx)"}oe(n[2])?Number(n[2])?e.code.push("self.MemW1("+t+", self.Mem1("+t+") | "+s+");"):e.code.push("self.MemW1("+t+", self.Mem1("+t+") & ~("+s+"));"):(e.code.push("if ("+n[2]+") self.MemW1("+t+", self.Mem1("+t+") | "+s+");"),e.code.push("else self.MemW1("+t+", self.Mem1("+t+") & ~("+s+"));"))},80:function(e,n){var r,t=e.offstack.length;r=t?"self.frame.valstack.length+"+t:"self.frame.valstack.length",H(e,n[0],r)},81:function(e,n){var r;if(oe(n[0])){var t=Number(n[0]);r=t<e.offstack.length?e.offstack[e.offstack.length-(t+1)]:"self.frame.valstack[self.frame.valstack.length-"+(t+1-e.offstack.length)+"]"}else $(e),r="self.frame.valstack[self.frame.valstack.length-("+n[0]+"+1)]";H(e,n[1],r)},82:function(e,n){var r,t;e.offstack.length<2&&ae(e,2),t=e.offstack.length,r=e.offstack[t-1],e.offstack[t-1]=e.offstack[t-2],e.offstack[t-2]=r},83:function(e,n){$(e),e.varsused.ix=!0,e.varsused.pos=!0,e.varsused.roll=!0,e.varsused.vals1=!0;var r=Y(e,n[0],!0),t=Y(e,n[1],!0);e.code.push("if ("+r+" > 0) {"),e.code.push("if ("+t+" > 0) {"),e.code.push("vals1 = "+t+" % "+r+";"),e.code.push("} else {"),e.code.push("vals1 = "+r+" - (-("+t+")) % "+r+";"),e.code.push("}"),e.code.push("if (vals1) {"),e.code.push("pos = self.frame.valstack.length - "+r+";"),e.code.push("roll = self.frame.valstack.slice(self.frame.valstack.length-vals1, self.frame.valstack.length).concat(self.frame.valstack.slice(pos, self.frame.valstack.length-vals1));"),e.code.push("for (ix=0; ix<"+r+"; ix++) { self.frame.valstack[pos+ix] = roll[ix]; }"),e.code.push("roll = undefined;"),e.code.push("}"),e.code.push("}")},84:function(e,n){if($(e),oe(n[0])){var r,t,s=Number(n[0]);for(r=0;r<s;r++)t=ne(e,!0),e.offstack.push(t),e.code.push(t+"=self.frame.valstack[self.frame.valstack.length-"+(s-r)+"];")}else e.varsused.ix=!0,e.varsused.jx=!0,e.code.push("jx = self.frame.valstack.length-("+n[0]+");"),e.code.push("for (ix=0; ix<"+n[0]+"; ix++) { self.frame.valstack.push(self.frame.valstack[jx+ix]); }")},256:function(e,n){var r="self.do_gestalt(("+n[0]+"),("+n[1]+"))";e.code.push(n[2]+r+");")},257:function(e,n){e.code.push("self.fatal_error('User debugtrap encountered.', "+n[0]+");")},258:function(e,n){e.code.push(n[0]+"self.endmem);")},259:function(e,n){e.code.push("self.change_memsize("+n[0]+",false);"),e.code.push(n[1]+"0);")},272:function(e,n){var r;if(oe(n[0])){var t=4294967295&Number(n[0]);r=0==t?"(Math.floor(self.random_func() * 0x10000) | (Math.floor(self.random_func() * 0x10000) << 16)) >>>0":t>0?"Math.floor(self.random_func() * "+t+")":"-Math.floor(self.random_func() * "+-t+")"}else{var s=Y(e,n[0],!0),a=ne(e);r=a,e.code.push("if ("+s+" > 0)"),e.code.push(a+" = Math.floor(self.random_func() * "+s+");"),e.code.push("else if ("+s+" < 0)"),e.code.push(a+" = -Math.floor(self.random_func() * -"+s+");"),e.code.push("else"),e.code.push(a+" = (Math.floor(self.random_func() * 0x10000) | (Math.floor(self.random_func() * 0x10000) << 16)) >>>0;")}e.code.push(n[1]+r+");")},273:function(e,n){e.code.push("self.set_random("+n[0]+");")},288:function(e,n){e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("return self.VMStopped;"),e.path_ends=!0},289:function(e,n){e.code.push(n[0]+"self.perform_verify());")},290:function(e,n){e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("self.vm_restart();"),e.code.push("return;"),e.path_ends=!0},291:function(e,n){$(e),e.varsused.ix=!0,Z(e,n[1]),e.code.push("ix = self.vm_save("+n[0]+");"),e.code.push("self.pop_callstub(ix ? 0 : 1);"),e.code.push("return;"),e.path_ends=!0},292:function(e,n){$(e),e.code.push("if (self.vm_restore("+n[0]+")) {"),e.code.push("self.pop_callstub((-1)>>>0);"),e.code.push("} else {"),H(e,n[1],"1"),$(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("}"),e.code.push("return;"),e.path_ends=!0},293:function(e,n){$(e),Z(e,n[0]),e.code.push("self.vm_saveundo();"),e.code.push("self.pop_callstub(0);"),e.code.push("return;"),e.path_ends=!0},294:function(e,n){$(e),e.code.push("if (self.vm_restoreundo()) {"),e.code.push("self.pop_callstub((-1)>>>0);"),e.code.push("} else {"),H(e,n[0],"1"),$(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("}"),e.code.push("return;"),e.path_ends=!0},295:function(e,n){e.code.push("self.protectstart="+n[0]+";"),e.code.push("self.protectend=self.protectstart+("+n[1]+");"),e.code.push("if (self.protectstart==self.protectend) {"),e.code.push("  self.protectstart=0; self.protectend=0;"),e.code.push("}")},368:function(e,n){e.varsused.maddr=!0,e.varsused.mlen=!0,e.varsused.ix=!0,e.code.push("mlen="+n[0]+";"),e.code.push("maddr="+n[1]+";"),e.code.push("for (ix=0; ix<mlen; ix++, maddr++) self.MemW1(maddr, 0);")},369:function(e,n){e.varsused.msrc=!0,e.varsused.mdest=!0,e.varsused.mlen=!0,e.varsused.ix=!0,e.code.push("mlen="+n[0]+";"),e.code.push("msrc="+n[1]+";"),e.code.push("mdest="+n[2]+";"),e.code.push("if (mdest < msrc) {"),e.code.push("for (ix=0; ix<mlen; ix++, msrc++, mdest++) self.MemW1(mdest, self.Mem1(msrc));"),e.code.push("} else {"),e.code.push("msrc += (mlen-1); mdest += (mlen-1);"),e.code.push("for (ix=0; ix<mlen; ix++, msrc--, mdest--) self.MemW1(mdest, self.Mem1(msrc));"),e.code.push("}")},376:function(e,n){var r="self.heap_malloc("+n[0]+")";e.code.push(n[1]+r+");")},377:function(e,n){e.code.push("self.heap_free("+n[0]+");")},384:function(e,n){e.code.push("self.accel_funcnum_map["+n[1]+"] = "+n[0]+";"),e.code.push("self.accel_address_map["+n[1]+"] = self.accel_func_map["+n[0]+"];")},385:function(e,n){e.code.push("if ("+n[0]+" < 9) {"),e.code.push("  self.accel_params["+n[0]+"] = "+n[1]+";"),e.code.push("}")},336:function(e,n){var r="self.linear_search(("+n[0]+"),("+n[1]+"),("+n[2]+"),("+n[3]+"),("+n[4]+"),("+n[5]+"),("+n[6]+"))";e.code.push(n[7]+r+");")},337:function(e,n){var r="self.binary_search(("+n[0]+"),("+n[1]+"),("+n[2]+"),("+n[3]+"),("+n[4]+"),("+n[5]+"),("+n[6]+"))";e.code.push(n[7]+r+");")},338:function(e,n){var r="self.linked_search(("+n[0]+"),("+n[1]+"),("+n[2]+"),("+n[3]+"),("+n[4]+"),("+n[5]+"))";e.code.push(n[6]+r+");")},112:function(e,n){switch(e.curiosys){case 2:if(oe(n[0])){var r=255&Number(n[0]);e.code.push("Glk.glk_put_char("+r+");")}else e.code.push("Glk.glk_put_char(("+n[0]+")&0xff);");break;case 1:$(e),e.code.push("self.tempcallargs[0]=(("+n[0]+")&0xff);"),Z(e,"0,0"),e.code.push("self.enter_function(self.iosysrock, 1);"),e.code.push("return;"),e.path_ends=!0;break;case 0:}},113:function(e,n){switch(e.curiosys){case 2:var r=Y(e,n[0]);if(oe(n[0])){var t=Number(r).toString(10);e.code.push("Glk.glk_put_jstring("+T(t)+", true);")}else e.code.push("Glk.glk_put_jstring(("+r+").toString(10), true);");break;case 1:$(e),e.code.push("self.stream_num("+e.cp+","+n[0]+", false, 0);"),e.code.push("return;"),e.path_ends=!0;break;case 0:}},114:function(e,n){$(e),e.code.push("if (self.stream_string("+e.cp+","+n[0]+", 0, 0)) return;")},115:function(e,n){switch(e.curiosys){case 2:if(oe(n[0])){var r=Number(n[0]);e.code.push("Glk.glk_put_char_uni("+r+");")}else e.code.push("Glk.glk_put_char_uni("+n[0]+");");break;case 1:$(e),e.code.push("self.tempcallargs[0]=("+n[0]+");"),Z(e,"0,0"),e.code.push("self.enter_function(self.iosysrock, 1);"),e.code.push("return;"),e.path_ends=!0;break;case 0:}},320:function(e,n){e.code.push(n[0]+"self.stringtable)")},321:function(e,n){e.code.push("self.set_string_table("+n[0]+");")},328:function(e,n){e.code.push(n[0]+"self.iosysmode)"),e.code.push(n[1]+"self.iosysrock)")},329:function(e,n){if(e.code.push("self.set_iosys("+n[0]+","+n[1]+");"),oe(n[0])){var r=Number(n[0]);e.curiosys=r}else $(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("return;"),e.path_ends=!0},400:function(e,n){var r=Y(e,n[0]);if(oe(n[0])){var t=Number(r);e.code.push(n[1]+Te(t)+");")}else e.code.push(n[1]+"self.encode_float("+r+"));")},401:function(e,n){e.varsused.valf=!0,e.varsused.res=!0,e.code.push("valf = "+K(e,n[0])+";"),e.code.push("if (!("+n[0]+" & 0x80000000)) {"),e.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf > 0x7fffffff))"),e.code.push("    res = 0x7fffffff;"),e.code.push("  else"),e.code.push("    res = Math.floor(valf);"),e.code.push("} else {"),e.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf < -0x80000000))"),e.code.push("    res = -0x80000000;"),e.code.push("  else"),e.code.push("    res = Math.ceil(valf);"),e.code.push("}"),e.code.push(n[1]+"res>>>0);")},402:function(e,n){e.varsused.valf=!0,e.varsused.res=!0,e.code.push("valf = "+K(e,n[0])+";"),e.code.push("if (!("+n[0]+" & 0x80000000)) {"),e.code.push("  if (isNaN(valf) || !isFinite(valf))"),e.code.push("    res = 0x7fffffff;"),e.code.push("  else"),e.code.push("    res = Math.round(valf);"),e.code.push("  if (res > 0x7fffffff) res = 0x7fffffff;"),e.code.push("} else {"),e.code.push("  if (isNaN(valf) || !isFinite(valf))"),e.code.push("    res = -0x80000000;"),e.code.push("  else"),e.code.push("    res = Math.round(valf);"),e.code.push("  if (res < -0x80000000) res = -0x80000000;"),e.code.push("}"),e.code.push(n[1]+"res>>>0);")},408:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.ceil("+r+")));")},409:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.floor("+r+")));")},416:function(e,n){var r=K(e,n[0]),t=K(e,n[1]);e.code.push(n[2]+"self.encode_float("+r+" + "+t+"));")},417:function(e,n){var r=K(e,n[0]),t=K(e,n[1]);e.code.push(n[2]+"self.encode_float("+r+" - "+t+"));")},418:function(e,n){var r=K(e,n[0]),t=K(e,n[1]);e.code.push(n[2]+"self.encode_float("+r+" * "+t+"));")},419:function(e,n){var r=K(e,n[0]),t=K(e,n[1]);e.code.push(n[2]+"self.encode_float("+r+" / "+t+"));")},420:function(e,n){var r=K(e,n[0],!0),t=K(e,n[1],!0);e.varsused.modv=!0,e.varsused.quov=!0,e.code.push("modv=("+r+" % "+t+");"),e.code.push("quov=self.encode_float(("+r+" - modv) / "+t+");"),e.code.push("if (quov == 0x0 || quov == 0x80000000) {"),e.code.push("  quov = (("+n[0]+" ^ "+n[1]+") & 0x80000000) >>>0;"),e.code.push("}"),e.code.push(n[2]+"self.encode_float(modv));"),e.code.push(n[3]+"quov);")},424:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.sqrt("+r+")));")},425:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.exp("+r+")));")},426:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.log("+r+")));")},427:function(e,n){e.varsused.valf=!0;var r=K(e,n[0],!0),t=K(e,n[1],!0);e.code.push("if ("+n[0]+" == 0x3f800000) {"),e.code.push("  valf = 0x3f800000;"),e.code.push("} else if ("+n[0]+" == 0xbf800000 && ("+n[1]+" == 0xff800000 || "+n[1]+" == 0x7f800000)) {"),e.code.push("  valf = 0x3f800000;"),e.code.push("} else {"),e.code.push("  valf=self.encode_float(Math.pow("+r+", "+t+"));"),e.code.push("}"),e.code.push(n[2]+"valf);")},432:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.sin("+r+")));")},433:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.cos("+r+")));")},434:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.tan("+r+")));")},435:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.asin("+r+")));")},436:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.acos("+r+")));")},437:function(e,n){var r=K(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.atan("+r+")));")},438:function(e,n){var r=K(e,n[0]),t=K(e,n[1]);e.code.push(n[2]+"self.encode_float(Math.atan2("+r+", "+t+")));")},448:function(e,n){var r,t,s,a;e.varsused.fequal=!0,e.varsused.fdiff=!0,e.code.push("if (("+n[2]+" & 0x7f800000) == 0x7f800000 && ("+n[2]+" & 0x007fffff) != 0) {"),e.code.push("  fequal = 0;"),e.code.push("} else if (("+n[0]+" == 0xff800000 || "+n[0]+" == 0x7f800000) && ("+n[1]+" == 0xff800000 || "+n[1]+" == 0x7f800000)) {"),e.code.push("  fequal = ("+n[0]+" == "+n[1]+");"),e.code.push("} else {"),oe(n[2])?(r=Number(n[2]),a=""+We(2147483647&r)):(r="self.decode_float(("+n[2]+") & 0x7fffffff)",a=ne(e),e.code.push(a+"="+r+";")),t=K(e,n[0]),s=K(e,n[1]),e.code.push("  fdiff = "+s+" - "+t+";"),e.code.push("  fequal = (fdiff <= "+a+" && fdiff >= -("+a+"));"),e.code.push("}"),e.code.push("if (fequal) {"),ee(e,n[3]),e.code.push("}")},449:function(e,n){var r,t,s,a;e.varsused.fequal=!0,e.varsused.fdiff=!0,e.code.push("if (("+n[2]+" & 0x7f800000) == 0x7f800000 && ("+n[2]+" & 0x007fffff) != 0) {"),e.code.push("  fequal = 0;"),e.code.push("} else if (("+n[0]+" == 0xff800000 || "+n[0]+" == 0x7f800000) && ("+n[1]+" == 0xff800000 || "+n[1]+" == 0x7f800000)) {"),e.code.push("  fequal = ("+n[0]+" == "+n[1]+");"),e.code.push("} else {"),oe(n[2])?(r=Number(n[2]),a=""+We(2147483647&r)):(r="self.decode_float(("+n[2]+") & 0x7fffffff)",a=ne(e),e.code.push(a+"="+r+";")),t=K(e,n[0]),s=K(e,n[1]),e.code.push("  fdiff = "+s+" - "+t+";"),e.code.push("  fequal = (fdiff <= "+a+" && fdiff >= -("+a+"));"),e.code.push("}"),e.code.push("if (!fequal) {"),ee(e,n[3]),e.code.push("}")},450:function(e,n){valf0=K(e,n[0]),valf1=K(e,n[1]),e.code.push("if ("+valf0+" < "+valf1+") {"),ee(e,n[2]),e.code.push("}")},451:function(e,n){valf0=K(e,n[0]),valf1=K(e,n[1]),e.code.push("if ("+valf0+" <= "+valf1+") {"),ee(e,n[2]),e.code.push("}")},452:function(e,n){valf0=K(e,n[0]),valf1=K(e,n[1]),e.code.push("if ("+valf0+" > "+valf1+") {"),ee(e,n[2]),e.code.push("}")},453:function(e,n){valf0=K(e,n[0]),valf1=K(e,n[1]),e.code.push("if ("+valf0+" >= "+valf1+") {"),ee(e,n[2]),e.code.push("}")},456:function(e,n){e.code.push("if (("+n[0]+" & 0x7f800000) == 0x7f800000 && ("+n[0]+" & 0x007fffff) != 0) {"),ee(e,n[1]),e.code.push("}")},457:function(e,n){e.code.push("if ("+n[0]+" == 0xff800000 || "+n[0]+" == 0x7f800000) {"),ee(e,n[1]),e.code.push("}")},304:function(e,n){var r;if(r=!oe(n[0])||Glk.call_may_not_return(Number(n[0])),r&&(e.code.push("  self.prevpc = "+e.prevcp+";"),e.code.push("  self.pc = "+e.cp+";")),e.code.push("self.tempglkargs.length = "+n[1]+";"),oe(n[1])){var t,s=Number(n[1]);for(t=0;t<s;t++)if(e.offstack.length){var a=re(e);e.code.push("self.tempglkargs["+t+"]="+a+";")}else e.code.push("self.tempglkargs["+t+"]=self.frame.valstack.pop();");$(e)}else e.varsused.ix=!0,$(e),e.code.push("for (ix=0; ix<"+n[1]+"; ix++) { self.tempglkargs[ix]=self.frame.valstack.pop(); }");e.varsused.glkret=!0,e.code.push("glkret = GiDispa.get_function("+n[0]+")(self.tempglkargs);"),r&&(e.code.push("if (glkret === Glk.DidNotReturn) {"),e.code.push("  self.resumefuncop = "+Q(n[2])+";"),e.code.push("  self.resumevalue = 0;"),e.code.push("  self.pc = "+e.cp+";"),e.code.push("  self.done_executing = true;"),e.code.push("  return;"),e.code.push("}")),
H(e,n[2],"glkret")}};pn.enter_function=ue,pn.leave_function=de,pn.pop_stack_to=he,pn.pop_callstub=pe,pn.store_operand=me,pn.set_random=_e;var kn,bn,yn=void 0,xn={},Mn={};pn.accel_address_map=xn,pn.accel_funcnum_map=Mn;var zn=[0,0,0,0,0,0,0,0,0];pn.accel_params=zn;var Sn={1:function(e,n){if(e<1)return 0;var r=n[0];if(r<36)return 0;if(r>=pn.endmem)return 0;var t=c(r);return t>=224?3:t>=192?2:t>=112&&t<=127&&r>=In?1:0},2:function(e,n){var r=e>0?n[0]:0,t=e>1?n[1]:0;if(1!=Sn[1](e,n))return Glk.glk_put_jstring('\n[** Programming error: tried to find the "." of (something) **]\n'),0;var s=d(r+16);if(!s)return 0;var a=d(s);return s+=4,Ae(t,2,s,10,a,0,0)},3:function(e,n){var r=e>0?n[0]:0,t=e>1?n[1]:0,s=ye(r,t);return 0==s?0:d(s+4)},4:function(e,n){var r=e>0?n[0]:0,t=e>1?n[1]:0,s=ye(r,t);return 0==s?0:4*u(s+2)},5:function(e,n){var r,t,s,a,o,i=e>0?n[0]:0,l=e>1?n[1]:0;if(r=Sn[1](e,n),3==r)return l==zn[5]?1:0;if(2==r)return l==zn[4]?1:0;if(1!=r)return 0;if(l==zn[2])return be(i)?1:i==zn[2]?1:i==zn[5]?1:i==zn[4]?1:i==zn[3]?1:0;if(l==zn[3])return be(i)?0:i==zn[2]?0:i==zn[5]?0:i==zn[4]?0:i==zn[3]?0:1;if(l==zn[5]||l==zn[4])return 0;if(!be(l))return Glk.glk_put_jstring("\n[** Programming error: tried to apply 'ofclass' with non-class **]\n"),0;if(t=ye(i,2),0==t)return 0;if(s=d(t+4),0==s)return 0;for(a=u(t+2),o=0;o<a;o++)if(d(s+4*o)==l)return 1;return 0},6:function(e,n){var r,t=e>1?n[1]:0;return r=Sn[3](e,n),0==r?t>0&&t<zn[1]?d(zn[8]+4*t):(Glk.glk_put_jstring("\n[** Programming error: tried to read (something) **]\n"),0):d(r)},7:function(e,n){var r=e>0?n[0]:0,t=e>1?n[1]:0,s=zn[1],a=Sn[1](e,n);return 3==a?t==s+6?1:t==s+7?1:0:2==a?t==s+5?1:0:1!=a?0:t>=s&&t<s+8&&be(r)?1:Sn[3](e,n)?1:0},8:function(e,n){var r=e>0?n[0]:0,t=e>1?n[1]:0;if(1!=Sn[1](e,n))return Glk.glk_put_jstring('\n[** Programming error: tried to find the "." of (something) **]\n'),0;var s=d(r+4*(3+(zn[7]>>2)));if(!s)return 0;var a=d(s);return s+=4,Ae(t,2,s,10,a,0,0)},9:function(e,n){var r=e>0?n[0]:0,t=e>1?n[1]:0,s=xe(r,t);return 0==s?0:d(s+4)},10:function(e,n){var r=e>0?n[0]:0,t=e>1?n[1]:0,s=xe(r,t);return 0==s?0:4*u(s+2)},11:function(e,n){var r,t,s,a,o,i=e>0?n[0]:0,l=e>1?n[1]:0;if(r=Sn[1](e,n),3==r)return l==zn[5]?1:0;if(2==r)return l==zn[4]?1:0;if(1!=r)return 0;if(l==zn[2])return be(i)?1:i==zn[2]?1:i==zn[5]?1:i==zn[4]?1:i==zn[3]?1:0;if(l==zn[3])return be(i)?0:i==zn[2]?0:i==zn[5]?0:i==zn[4]?0:i==zn[3]?0:1;if(l==zn[5]||l==zn[4])return 0;if(!be(l))return Glk.glk_put_jstring("\n[** Programming error: tried to apply 'ofclass' with non-class **]\n"),0;if(t=xe(i,2),0==t)return 0;if(s=d(t+4),0==s)return 0;for(a=u(t+2),o=0;o<a;o++)if(d(s+4*o)==l)return 1;return 0},12:function(e,n){var r,t=e>1?n[1]:0;return r=Sn[9](e,n),0==r?t>0&&t<zn[1]?d(zn[8]+4*t):(Glk.glk_put_jstring("\n[** Programming error: tried to read (something) **]\n"),0):d(r)},13:function(e,n){var r=e>0?n[0]:0,t=e>1?n[1]:0,s=zn[1],a=Sn[1](e,n);return 3==a?t==s+6?1:t==s+7?1:0:2==a?t==s+5?1:0:1!=a?0:t>=s&&t<s+8&&be(r)?1:Sn[9](e,n)?1:0}};pn.accel_func_map=Sn;var Cn=[0,0];pn.set_string_table=Me,pn.set_iosys=ze,pn.stream_num=Ce,pn.stream_string=Ge,pn.do_gestalt=je,pn.linear_search=Le,pn.binary_search=Ae,pn.linked_search=Ee,pn.decode_float=We,pn.encode_float=Te;var Gn,Nn,jn=null,Fn=null,Ln=null,An=null,En=null;pn.frame=null,pn.vm_started=!1,pn.vm_stopped=!1,pn.tempcallargs=null,pn.tempglkargs=null,pn.done_executing=null;var Wn,Tn,qn,Vn;pn.random_func=null;var In,Rn,Dn,On,Un,Pn,Bn;pn.pc=null,pn.stringtable=null,pn.endmem=null,pn.protectstart=null,pn.protectend=null,pn.iosysmode=null,pn.iosysrock=null,pn.prevpc=null;var Qn;pn.resumefuncop=null,pn.resumevalue=null;var Hn,Zn,Jn,$n=0,Xn=0,Yn=0,Kn=0,er=0,nr=0,rr=0,tr=0;pn.vm_restart=Ve,pn.vm_save=Ue,pn.vm_restore=Pe,pn.vm_saveundo=He,pn.vm_restoreundo=Ze,pn.change_memsize=Je,pn.perform_verify=Ye,pn.heap_malloc=ln,pn.heap_free=fn,pn.assert_heap_valid=cn;var sr={map:{},functions:[],functionmap:{}};return pn.VMStopped={dummy:"The top-level function has returned."},{version:"2.1.6",prepare:e,init:n,resume:r,get_signature:Ke,get_vm_internals:en,get_statistics:nn,get_debuginfo:un,ReadByte:S,WriteByte:C,ReadWord:G,WriteWord:N,ReadStructField:j,WriteStructField:F,SetResumeStore:L,do_autosave:Be}}(),/* GiDispa -- a GlkAPI dispatch layer for Quixe
 * Designed by Andrew Plotkin <erkyrath@eblong.com>
 * <http://eblong.com/zarf/glulx/quixe/>
 * 
 * This Javascript library is copyright 2010-2016 by Andrew Plotkin.
 * It is distributed under the MIT license; see the "LICENSE" file.
 *
 * This is the code layer that sits in between Quixe and GlkAPI. It provides
 * Glk entry points for every Glk call; Quixe's @glk opcode invokes these. It
 * also translates between Glk opaque objects (windows, streams, filerefs, etc)
 * to Quixe 32-bit numeric IDs.
 *
 * (A few calls, or arguments of calls, are marked "for autosave/autorestore
 * only". These exist for the purpose of getting a game displayed in a known
 * state, which is rather more complicated than the usual situation of 
 * letting a game start up and run.)
 */
GiDispa=function(){function e(e){j.VM=e}function n(e,n,r){this.id=e,this.name=n,this.proto=r}function r(e,n){this.args=e,this.retarg=n}function t(){this.macro="Byte",this.refsize=1,this.serialize=function(){return{type:"ArgString"}}}function s(){this.macro="Word",this.refsize=4,this.serialize=function(){return{type:"ArgUnicode"}}}function a(e){this.signed=e,this.macro="Byte",this.refsize=1,this.literal=e?"arg_char_signed":"arg_char_unsigned",this.serialize=function(){return{type:"ArgChar",signed:e}}}function o(e){this.signed=e,this.macro="Word",this.refsize=4,this.literal=e?"arg_int_signed":"arg_int_unsigned",this.serialize=function(){return{type:"ArgInt",signed:e}}}function i(e){this.name=e,this.macro="Word",this.refsize=4}function l(e){this.form=e}function f(e,n,r,t){this.arg=e,this.passin=n,this.passout=r,this.nonnull=t}function c(e,n,r,t,s){this.arg=e,this.retained=n,this.passin=r,this.passout=t,this.nonnull=s}function u(e){switch(e.type){case"ArgString":return new t;case"ArgUnicode":return new s;case"ArgInt":return e.signed?A:L;case"ArgChar":return null===e.signed?W:e.signed?T:E}throw new Error("arg_deserialize: unknown type: "+e.type)}function d(e,n,r){return e instanceof o?n?e.signed?r+" & 0xFFFFFFFF":r:"0":e instanceof a?n?e.signed?"self.cast_signed_char("+r+")":r+" & 0xFF":"0":e instanceof i?n?'self.class_obj_from_id("'+e.name+'", '+r+")":"null":"???"}function h(e,n){return e instanceof o?n+" >>> 0":e instanceof a?e.signed?"self.uncast_signed_char("+n+")":n+" & 0xFF":e instanceof i?'self.class_obj_to_id("'+e.name+'", '+n+")":"???"}function p(e){return e=255&e,128&e&&(e-=256),e}function m(e){return e=255&e,128&e&&(e+=4294967040),e}function v(e,n){return n?n.disprock:0}function g(e,n){return 0!=n&&n?J[e][n]:null}function _(e){var n,r,u,p,m,v,g,_,w,k,b,y,x,M,z=[],S={},C=0;for(z.push("// no local vars"),z.push("// "+e.id+": "+e.name),u=e.proto,p=null,u.retarg&&(p=u.retarg.arg),z.push("var self = this;"),M=Glk.call_may_not_return(e.id),m=0,v=[],n=0;n<u.args.length;n++)if(_=u.args[n],k="glka"+n,v.push(k),S[k]=!0,_ instanceof o||_ instanceof a||_ instanceof i)b=d(_,!0,"callargs["+m+"]"),z.push(k+" = "+b+";"),m+=1;else if(_ instanceof f){if(w=_.arg,z.push("if (callargs["+m+"] == 0) {"),_.nonnull?z.push('  throw new Error("glk '+e.name+': null argument");'):z.push("  "+k+" = null;"),z.push("} else {"),w instanceof o||w instanceof a||w instanceof i)z.push("  "+k+" = new Glk.RefBox();"),b=d(w,_.passin,"self.VM.ReadWord(callargs["+m+"])"),z.push("  "+k+".set_value("+b+");");else{if(!(w instanceof l))throw new Error("buildfunc: unsupported refarg type: "+e.name);for(g=w.form.args,z.push("  "+k+" = new Glk.RefStruct("+g.length+");"),r=0;r<g.length;r++)b=d(g[r],_.passin,"self.VM.ReadStructField(callargs["+m+"], "+r+")"),z.push("  "+k+".push_field("+b+");")}z.push("}"),m+=1}else if(_ instanceof c)S.glklen=!0,w=_.arg,z.push("if (callargs["+m+"] == 0) {"),_.nonnull?z.push('  throw new Error("glk '+e.name+': null argument");'):z.push("  "+k+" = null;"),z.push("} else {"),z.push("  glklen = callargs["+(m+1)+"];"),z.push("  "+k+" = Array(glklen);"),_.passin&&(S.ix=!0,S.jx=!0,z.push("  for (ix=0, jx=callargs["+m+"]; ix<glklen; ix++, jx+="+w.refsize+") {"),b=d(w,!0,"self.VM.Read"+w.macro+"(jx)"),z.push("    "+k+"[ix] = "+b+";"),z.push("  }")),_.retained&&(0==C&&z.push("  self.temp_arg_arrays.length = 0;"),C+=1,z.push("  self.make_arg_array("+k+", callargs["+m+"], glklen, self."+w.literal+");")),z.push("}"),m+=2;else{if(!(_ instanceof t||_ instanceof s))throw new Error("buildfunc: unsupported arg type: "+e.name);S.ix=!0,S.jx=!0;var G,N;_ instanceof t?(N="0xE0",G="byte_array_to_string"):(N="0xE2",G="uni_array_to_string"),z.push(k+" = Array();"),z.push("jx = callargs["+m+"];"),z.push("if (self.VM.ReadByte(jx) != "+N+') throw new Error("glk '+e.name+': string argument must be unencoded");'),z.push("for (jx+="+_.refsize+"; true; jx+="+_.refsize+") {"),z.push("  ix = self.VM.Read"+_.macro+"(jx);"),z.push("  if (ix == 0) break;"),z.push("  "+k+".push(ix);"),z.push("}"),z.push(k+" = Glk."+G+"("+k+");"),m+=1}for(z.push("if (callargs.length != "+m+') throw "glk '+e.name+': wrong number of arguments";'),p||M?(S.glkret=!0,y="glkret = "):y="",z.push(y+"Glk.glk_"+e.name+"("+v.join(", ")+");"),M&&(z.push("if (glkret === Glk.DidNotReturn) {"),z.push("  self.set_blocked_selector("+e.id+", callargs);"),z.push("  return glkret;"),z.push("}")),m=0,n=0;n<u.args.length;n++)if(_=u.args[n],k="glka"+n,_ instanceof o||_ instanceof a||_ instanceof i)m+=1;else if(_ instanceof f){if(w=_.arg,_.passout){if(z.push("if ("+k+") {"),w instanceof o||w instanceof a||w instanceof i)b=h(w,k+".get_value()"),z.push("  self.VM.WriteWord(callargs["+m+"], "+b+");");else{if(!(w instanceof l))throw new Error("buildfunc: unsupported refarg type: "+e.name);for(g=w.form.args,r=0;r<g.length;r++)b=h(g[r],k+".get_field("+r+")"),z.push("  self.VM.WriteStructField(callargs["+m+"], "+r+", "+b+");")}z.push("}")}m+=1}else if(_ instanceof c)w=_.arg,_.passout&&!_.retained&&(z.push("if ("+k+") {"),S.ix=!0,S.jx=!0,z.push("  for (ix=0, jx=callargs["+m+"]; ix<glklen; ix++, jx+="+w.refsize+") {"),b=h(w,k+"[ix]"),z.push("    self.VM.Write"+w.macro+"(jx, "+b+")"),z.push("  }"),z.push("}")),m+=2;else{if(!(_ instanceof t||_ instanceof s))throw new Error("buildfunc: unsupported arg type: "+e.name);m+=1}0!=C&&z.push("self.temp_arg_arrays.length = 0;"),p?(b=h(p,"glkret"),z.push("return "+b+";")):z.push("return 0;"),x=[];for(b in S)x.push(b);x.length&&(z[0]="var "+x.join(", ")+";"),b=z.join("\n");var F=new Function("callargs",b);return F.bind(j)}function w(e){var n,r=O[e];if(void 0===r){if(n=D[e],void 0===n)throw new Error("dispatch: unknown Glk function: "+e);r=_(n),O[e]=r}return r}function k(e,n){U=e,P=n.slice(0)}/* Check whether this is a good time for autosave. This is an awkward
   API call, but GiDispa is the easiest place to find this information.

   It's a good time for autosave if (a) we're blocked on glk_select
   (rather than glk_fileref_create_by_prompt or whatever); (b) we did
   not just launch; (c) we just responded to a keyboard or mouse event
   (as opposed to timer, resize, etc).

   If it's not a good time, return null. If it is, we return the VM address
   of the event structure, which the caller needs. (See, I told you it
   was awkward.)
*/
function b(){return 192==U&&P&&P.length>0&&(2==B||3==B||4==B||8==B)?P[0]:null}function y(e){192==U?0!=P[0]&&(B=e.get_field(0)>>>0,j.VM.WriteStructField(P[0],0,e.get_field(0)>>>0),j.VM.WriteStructField(P[0],1,v("window",e.get_field(1))),j.VM.WriteStructField(P[0],2,e.get_field(2)>>>0),j.VM.WriteStructField(P[0],3,e.get_field(3)>>>0)):98==U&&j.VM.SetResumeStore(v("fileref",e)),U=null,P=null}function x(e,n,r,t){var s;e&&(s={arr:e,addr:n,len:r,arg:t},Q.push(s))}function M(e,n){var r,t;if(e){if(void 0!==n){if(e!==n.arr)throw new Error("retain_array: array does not match useobj");if(t={addr:n.addr,len:n.len,arr:e,arg:u(n.arg)},t.len!=e.length)throw new Error("retain_array: array length from useobj does not match")}else for(t=void 0,r=0;r<Q.length;r++)if(Q[r].arr===e){t=Q[r];break}if(void 0===t)throw new Error("retain_array: array is not an argument");for(r=0;void 0!==H[r];r++);H[r]=t}}function z(e){var n;for(n=0;n<H.length;n++)if(void 0!==H[n]&&H[n].arr===e)return H[n];return null}function S(e){var n,r,t;if(e){for(t=void 0,n=0;n<H.length;n++)if(void 0!==H[n]&&H[n].arr===e){t=H[n],delete H[n];break}if(void 0===t)throw new Error("unretain_array: array was never retained");if(t.arg instanceof o)for(n=0,r=t.addr;n<t.len;n++,r+=4)j.VM.WriteWord(r,t.arr[n]>>>0);else{if(!(t.arg instanceof a))throw new Error("unretain_array: unsupported refarg type");if(t.arg.signed)for(n=0,r=t.addr;n<t.len;n++,r++)j.VM.WriteByte(r,m(t.arr[n]));else for(n=0,r=t.addr;n<t.len;n++,r++)j.VM.WriteByte(r,255&t.arr[n])}}}function C(e,n,r){if(void 0===r){if(n.disprock)throw new Error("class_register: object is already registered");n.disprock=Z,Z++}else{if(n.disprock!=r)throw new Error("class_register: object is not already registered");Z<=r&&(Z=r+1)}J[e][n.disprock]=n}function G(e,n){if(!n.disprock||void 0===J[e][n.disprock])throw new Error("class_unregister: object is not registered");delete J[e][n.disprock],n.disprock=void 0}function N(){var e,n;Z=1+Math.round(1e3*Math.random());for(e in F)n=F[e],J[n]={}}var j={};j.VM=null;var F={0:"window",1:"stream",2:"fileref",3:"schannel"},L=new o((!1)),A=new o((!0)),E=new a((!1)),W=new a(null),T=new a((!0)),q=new i("window"),V=new i("stream"),I=new i("fileref"),R=new i("schannel"),D={1:new n(1,"exit",new r([],null)),3:new n(3,"tick",new r([],null)),4:new n(4,"gestalt",new r([L,L],new f(L,(!1),(!0),(!0)))),5:new n(5,"gestalt_ext",new r([L,L,new c(L,(!1),(!0),(!0),(!1))],new f(L,(!1),(!0),(!0)))),32:new n(32,"window_iterate",new r([q,new f(L,(!1),(!0),(!1))],new f(q,(!1),(!0),(!0)))),33:new n(33,"window_get_rock",new r([q],new f(L,(!1),(!0),(!0)))),34:new n(34,"window_get_root",new r([],new f(q,(!1),(!0),(!0)))),35:new n(35,"window_open",new r([q,L,L,L,L],new f(q,(!1),(!0),(!0)))),36:new n(36,"window_close",new r([q,new f(new l(new r([L,L],null)),(!1),(!0),(!1))],null)),37:new n(37,"window_get_size",new r([q,new f(L,(!1),(!0),(!1)),new f(L,(!1),(!0),(!1))],null)),38:new n(38,"window_set_arrangement",new r([q,L,L,q],null)),39:new n(39,"window_get_arrangement",new r([q,new f(L,(!1),(!0),(!1)),new f(L,(!1),(!0),(!1)),new f(q,(!1),(!0),(!1))],null)),40:new n(40,"window_get_type",new r([q],new f(L,(!1),(!0),(!0)))),41:new n(41,"window_get_parent",new r([q],new f(q,(!1),(!0),(!0)))),42:new n(42,"window_clear",new r([q],null)),43:new n(43,"window_move_cursor",new r([q,L,L],null)),44:new n(44,"window_get_stream",new r([q],new f(V,(!1),(!0),(!0)))),45:new n(45,"window_set_echo_stream",new r([q,V],null)),46:new n(46,"window_get_echo_stream",new r([q],new f(V,(!1),(!0),(!0)))),47:new n(47,"set_window",new r([q],null)),48:new n(48,"window_get_sibling",new r([q],new f(q,(!1),(!0),(!0)))),64:new n(64,"stream_iterate",new r([V,new f(L,(!1),(!0),(!1))],new f(V,(!1),(!0),(!0)))),65:new n(65,"stream_get_rock",new r([V],new f(L,(!1),(!0),(!0)))),66:new n(66,"stream_open_file",new r([I,L,L],new f(V,(!1),(!0),(!0)))),67:new n(67,"stream_open_memory",new r([new c(W,(!0),(!0),(!0),(!1)),L,L],new f(V,(!1),(!0),(!0)))),68:new n(68,"stream_close",new r([V,new f(new l(new r([L,L],null)),(!1),(!0),(!1))],null)),69:new n(69,"stream_set_position",new r([V,A,L],null)),70:new n(70,"stream_get_position",new r([V],new f(L,(!1),(!0),(!0)))),71:new n(71,"stream_set_current",new r([V],null)),72:new n(72,"stream_get_current",new r([],new f(V,(!1),(!0),(!0)))),73:new n(73,"stream_open_resource",new r([L,L],new f(V,(!1),(!0),(!0)))),96:new n(96,"fileref_create_temp",new r([L,L],new f(I,(!1),(!0),(!0)))),97:new n(97,"fileref_create_by_name",new r([L,new t,L],new f(I,(!1),(!0),(!0)))),98:new n(98,"fileref_create_by_prompt",new r([L,L,L],new f(I,(!1),(!0),(!0)))),99:new n(99,"fileref_destroy",new r([I],null)),100:new n(100,"fileref_iterate",new r([I,new f(L,(!1),(!0),(!1))],new f(I,(!1),(!0),(!0)))),101:new n(101,"fileref_get_rock",new r([I],new f(L,(!1),(!0),(!0)))),102:new n(102,"fileref_delete_file",new r([I],null)),103:new n(103,"fileref_does_file_exist",new r([I],new f(L,(!1),(!0),(!0)))),104:new n(104,"fileref_create_from_fileref",new r([L,I,L],new f(I,(!1),(!0),(!0)))),128:new n(128,"put_char",new r([E],null)),129:new n(129,"put_char_stream",new r([V,E],null)),130:new n(130,"put_string",new r([new t],null)),131:new n(131,"put_string_stream",new r([V,new t],null)),132:new n(132,"put_buffer",new r([new c(W,(!1),(!0),(!1),(!0))],null)),133:new n(133,"put_buffer_stream",new r([V,new c(W,(!1),(!0),(!1),(!0))],null)),134:new n(134,"set_style",new r([L],null)),135:new n(135,"set_style_stream",new r([V,L],null)),144:new n(144,"get_char_stream",new r([V],new f(A,(!1),(!0),(!0)))),145:new n(145,"get_line_stream",new r([V,new c(W,(!1),(!1),(!0),(!0))],new f(L,(!1),(!0),(!0)))),146:new n(146,"get_buffer_stream",new r([V,new c(W,(!1),(!1),(!0),(!0))],new f(L,(!1),(!0),(!0)))),160:new n(160,"char_to_lower",new r([E],new f(E,(!1),(!0),(!0)))),161:new n(161,"char_to_upper",new r([E],new f(E,(!1),(!0),(!0)))),176:new n(176,"stylehint_set",new r([L,L,L,A],null)),177:new n(177,"stylehint_clear",new r([L,L,L],null)),178:new n(178,"style_distinguish",new r([q,L,L],new f(L,(!1),(!0),(!0)))),179:new n(179,"style_measure",new r([q,L,L,new f(L,(!1),(!0),(!1))],new f(L,(!1),(!0),(!0)))),192:new n(192,"select",new r([new f(new l(new r([L,q,L,L],null)),(!1),(!0),(!0))],null)),193:new n(193,"select_poll",new r([new f(new l(new r([L,q,L,L],null)),(!1),(!0),(!0))],null)),208:new n(208,"request_line_event",new r([q,new c(W,(!0),(!0),(!0),(!0)),L],null)),209:new n(209,"cancel_line_event",new r([q,new f(new l(new r([L,q,L,L],null)),(!1),(!0),(!1))],null)),210:new n(210,"request_char_event",new r([q],null)),211:new n(211,"cancel_char_event",new r([q],null)),212:new n(212,"request_mouse_event",new r([q],null)),213:new n(213,"cancel_mouse_event",new r([q],null)),214:new n(214,"request_timer_events",new r([L],null)),224:new n(224,"image_get_info",new r([L,new f(L,(!1),(!0),(!1)),new f(L,(!1),(!0),(!1))],new f(L,(!1),(!0),(!0)))),225:new n(225,"image_draw",new r([q,L,A,A],new f(L,(!1),(!0),(!0)))),226:new n(226,"image_draw_scaled",new r([q,L,A,A,L,L],new f(L,(!1),(!0),(!0)))),232:new n(232,"window_flow_break",new r([q],null)),233:new n(233,"window_erase_rect",new r([q,A,A,L,L],null)),234:new n(234,"window_fill_rect",new r([q,L,A,A,L,L],null)),235:new n(235,"window_set_background_color",new r([q,L],null)),240:new n(240,"schannel_iterate",new r([R,new f(L,(!1),(!0),(!1))],new f(R,(!1),(!0),(!0)))),241:new n(241,"schannel_get_rock",new r([R],new f(L,(!1),(!0),(!0)))),242:new n(242,"schannel_create",new r([L],new f(R,(!1),(!0),(!0)))),243:new n(243,"schannel_destroy",new r([R],null)),244:new n(244,"schannel_create_ext",new r([L,L],new f(R,(!1),(!0),(!0)))),247:new n(247,"schannel_play_multi",new r([new c(R,(!1),(!0),(!1),(!0)),new c(L,(!1),(!0),(!1),(!0)),L],new f(L,(!1),(!0),(!0)))),248:new n(248,"schannel_play",new r([R,L],new f(L,(!1),(!0),(!0)))),249:new n(249,"schannel_play_ext",new r([R,L,L,L],new f(L,(!1),(!0),(!0)))),250:new n(250,"schannel_stop",new r([R],null)),251:new n(251,"schannel_set_volume",new r([R,L],null)),252:new n(252,"sound_load_hint",new r([L,L],null)),253:new n(253,"schannel_set_volume_ext",new r([R,L,L,L],null)),254:new n(254,"schannel_pause",new r([R],null)),255:new n(255,"schannel_unpause",new r([R],null)),256:new n(256,"set_hyperlink",new r([L],null)),257:new n(257,"set_hyperlink_stream",new r([V,L],null)),258:new n(258,"request_hyperlink_event",new r([q],null)),259:new n(259,"cancel_hyperlink_event",new r([q],null)),288:new n(288,"buffer_to_lower_case_uni",new r([new c(L,(!1),(!0),(!0),(!0)),L],new f(L,(!1),(!0),(!0)))),289:new n(289,"buffer_to_upper_case_uni",new r([new c(L,(!1),(!0),(!0),(!0)),L],new f(L,(!1),(!0),(!0)))),290:new n(290,"buffer_to_title_case_uni",new r([new c(L,(!1),(!0),(!0),(!0)),L,L],new f(L,(!1),(!0),(!0)))),291:new n(291,"buffer_canon_decompose_uni",new r([new c(L,(!1),(!0),(!0),(!0)),L],new f(L,(!1),(!0),(!0)))),292:new n(292,"buffer_canon_normalize_uni",new r([new c(L,(!1),(!0),(!0),(!0)),L],new f(L,(!1),(!0),(!0)))),296:new n(296,"put_char_uni",new r([L],null)),297:new n(297,"put_string_uni",new r([new s],null)),298:new n(298,"put_buffer_uni",new r([new c(L,(!1),(!0),(!1),(!0))],null)),299:new n(299,"put_char_stream_uni",new r([V,L],null)),300:new n(300,"put_string_stream_uni",new r([V,new s],null)),301:new n(301,"put_buffer_stream_uni",new r([V,new c(L,(!1),(!0),(!1),(!0))],null)),304:new n(304,"get_char_stream_uni",new r([V],new f(A,(!1),(!0),(!0)))),305:new n(305,"get_buffer_stream_uni",new r([V,new c(L,(!1),(!1),(!0),(!0))],new f(L,(!1),(!0),(!0)))),306:new n(306,"get_line_stream_uni",new r([V,new c(L,(!1),(!1),(!0),(!0))],new f(L,(!1),(!0),(!0)))),312:new n(312,"stream_open_file_uni",new r([I,L,L],new f(V,(!1),(!0),(!0)))),313:new n(313,"stream_open_memory_uni",new r([new c(L,(!0),(!0),(!0),(!1)),L,L],new f(V,(!1),(!0),(!0)))),314:new n(314,"stream_open_resource_uni",new r([L,L],new f(V,(!1),(!0),(!0)))),320:new n(320,"request_char_event_uni",new r([q],null)),321:new n(321,"request_line_event_uni",new r([q,new c(L,(!0),(!0),(!0),(!0)),L],null)),336:new n(336,"set_echo_line_event",new r([q,L],null)),337:new n(337,"set_terminators_line_event",new r([q,new c(L,(!1),(!0),(!1),(!1))],null)),352:new n(352,"current_time",new r([new f(new l(new r([A,L,A],null)),(!1),(!0),(!0))],null)),353:new n(353,"current_simple_time",new r([L],new f(A,(!1),(!0),(!0)))),360:new n(360,"time_to_date_utc",new r([new f(new l(new r([A,L,A],null)),(!0),(!1),(!0)),new f(new l(new r([A,A,A,A,A,A,A,A],null)),(!1),(!0),(!0))],null)),361:new n(361,"time_to_date_local",new r([new f(new l(new r([A,L,A],null)),(!0),(!1),(!0)),new f(new l(new r([A,A,A,A,A,A,A,A],null)),(!1),(!0),(!0))],null)),362:new n(362,"simple_time_to_date_utc",new r([A,L,new f(new l(new r([A,A,A,A,A,A,A,A],null)),(!1),(!0),(!0))],null)),363:new n(363,"simple_time_to_date_local",new r([A,L,new f(new l(new r([A,A,A,A,A,A,A,A],null)),(!1),(!0),(!0))],null)),364:new n(364,"date_to_time_utc",new r([new f(new l(new r([A,A,A,A,A,A,A,A],null)),(!0),(!1),(!0)),new f(new l(new r([A,L,A],null)),(!1),(!0),(!0))],null)),365:new n(365,"date_to_time_local",new r([new f(new l(new r([A,A,A,A,A,A,A,A],null)),(!0),(!1),(!0)),new f(new l(new r([A,L,A],null)),(!1),(!0),(!0))],null)),366:new n(366,"date_to_simple_time_utc",new r([new f(new l(new r([A,A,A,A,A,A,A,A],null)),(!0),(!1),(!0)),L],new f(A,(!1),(!0),(!0)))),367:new n(367,"date_to_simple_time_local",new r([new f(new l(new r([A,A,A,A,A,A,A,A],null)),(!0),(!1),(!0)),L],new f(A,(!1),(!0),(!0))))};j.arg_int_unsigned=L,j.arg_int_signed=A,j.arg_char_unsigned=E,j.arg_char_native=W,j.arg_char_signed=T,j.cast_signed_char=p,j.uncast_signed_char=m,j.class_obj_to_id=v,j.class_obj_from_id=g;var O={},U=null,P=null,B=-1;j.set_blocked_selector=k;var Q=[];j.temp_arg_arrays=Q;var H=[];j.retained_arrays=H,j.make_arg_array=x;var Z,J={};return N(),{set_vm:e,get_function:w,prepare_resume:y,check_autosave:b,class_register:C,class_unregister:G,class_obj_to_id:v,class_obj_from_id:g,retain_array:M,unretain_array:S,get_retained_array:z}}(),/* GiLoad -- a game-file loader for Quixe
 * Designed by Andrew Plotkin <erkyrath@eblong.com>
 * <http://eblong.com/zarf/glulx/quixe/>
 * 
 * This Javascript library is copyright 2010-2016 by Andrew Plotkin.
 * It is distributed under the MIT license; see the "LICENSE" file.
 *
 * This library loads a game image (by one of several possible methods)
 * and then starts up the display layer and game engine. It also extracts
 * data from a Blorb image, if that's what's provided.
 *
 * (This code makes use of the jQuery library, which therefore must be
 * available.)
 *
 * When you are putting together a Quixe installation page, you call
 * GiLoad.load_run() to get the game started. You should do this in the
 * document's "onload" handler, or later. (If you call it before "onload" 
 * time, it may not work.)
 *
 * You can do this in a couple of different ways:
 *
 * GiLoad.load_run(OPTIONS) -- load and run the game using the options
 *   passed as the argument. If OPTIONS is null or not provided, the
 *   global "game_options" object is considered. (The various options are
 *   described below.)
 *
 * GiLoad.load_run(OPTIONS, IMAGE, IMAGE_FORMAT) -- run the game with the
 *   given options. The IMAGE argument should be the game file itself
 *   (a glulx or blorb file). IMAGE_FORMAT describes how the game file
 *   is encoded:
 *     "base64": a base64-encoded binary file
 *     "raw": a binary file stored in a string
 *     "array": an array of (numeric) byte values
 *   Again, if OPTIONS is null, the global "game_options" object is
 *   considered.
 *
 * These are the game options. Most have default values, so you only have
 * to declare the ones you want to change.
 *
 *   use_query_story: If this is true, you (or the player) can use a
 *     "?story=..." URL parameter to load any game file. If it is false,
 *     this parameter is ignored. (default: true)
 *   set_page_title: If true, the loader will change the document title
 *     to describe the game being loaded. If false, the document title
 *     will be left alone. (default: true)
 *   default_page_title: A default label for the game, if none could be
 *     extracted from the metadata or URL. (default: "Game")
 *   default_story: The URL of the game file to load, if not otherwise
 *     provided.
 *   proxy_url: The URL of the web-app service which is used to convert
 *     binary data to Javascript, if the browser needs that. (default:
 *     http://zcode.appspot.com/proxy/)
 *   image_info_map: An object which describes all the available
 *     images, if they are provided as static URL data. (If this is not
 *     provided, we rely on Blorb resources.) This can be an object
 *     or a string; in the latter case, we look up a global object with
 *     that name.
 *   exit_warning: A message to display (in a blue warning pane) when
 *     the game exits. If empty or null, no message is displayed.
 *     (default: "The game session has ended.")
 *   do_vm_autosave: If set, the VM will check for a snapshot when
 *     launching, and load it if present. The VM will also save a snapshot
 *     after every move. (default: false)
 *   clear_vm_autosave: If set, the VM will clear any snapshot at launch
 *     (so will not load one even if do_vm_autosave is set). (default:
 *     false)
 *   vm: The game engine interface object. (default: Quixe)
 *   io: The display layer interface object. (default: Glk)
 *
 *   You can also include any of the display options used by the GlkOte
 *   library, such as gameport, windowport, spacing, ...
 *   And also the interpreter options used by the Quixe library, such as
 *   rethrow_exceptions, ...
 *
 * GiLoad.find_data_chunk(NUM) -- this finds the Data chunk of the
 *   given number from the Blorb file. The returned object looks like
 *   { data:[...], type:"..." } (where the type is TEXT or BINA).
 *   If there was no such chunk, or if the game was loaded from a non-
 *   Blorb file, this returns undefined.
 *
 * GiLoad.get_metadata(FIELD) -- this returns a metadata field (a
 *   string) from the iFiction <bibliographic> section. If there is
 *   no such field, or if the game was loaded from a non-Blorb
 *   file, this returns undefined.
 *
 * GiLoad.get_image_info(NUM) -- returns an object describing an image,
 *   or undefined.
 *
 * GiLoad.get_debug_info() -- returns an array containing debug info,
 *   or null.
 *
 * GiLoad.get_image_url(NUM) -- returns a URL describing an image, or
 *   undefined.
 */
GiLoad=function(){function e(e,t,s){if(p.vm=window.Quixe,p.io=window.Glk,e||(e=window.game_options),e&&jQuery.extend(p,e),void 0!=p.image_info_map&&"string"===jQuery.type(p.image_info_map)&&(window[p.image_info_map]?p.image_info_map=window[p.image_info_map]:delete p.image_info_map),m=null,p.use_query_story){var a=n();m=a.story}if(!m&&t){switch(GlkOte.log("GiLoad: trying pre-loaded load ("+s+")..."),s){case"base64":t=y(t);break;case"raw":t=decode_text(t);break;case"array":break;default:return void p.io.fatal_error("Could not decode story file data: "+s)}return void h(t)}if(m||(m=p.default_story),!m)return void p.io.fatal_error("No story file specified!");t=null,s=null;var o=new XMLHttpRequest,i=void 0!==o.overrideMimeType,l=void 0!==o.withCredentials;o=null;var c=/^(file:|(\w+:)?\/\/[^\/?#]+)/,u=c.exec(location)[0],d=c.exec(m),v=!d,g=d?d[0]:u,_=u==g;navigator.userAgent.match(/chrome/i)&&"file:"==g&&(_=!1);var w=m.match(/[.]js$/i);if(GlkOte.log("GiLoad: is_relative="+v+", same_origin="+_+", binary_supported="+i+", crossorigin_supported="+l),w&&_)return GlkOte.log("GiLoad: trying old-fashioned load..."),window.processBase64Zcode=function(e){h(y(e))},void jQuery.ajax(m,{type:"GET",dataType:"script",cache:!0,error:function(e,n,r){p.io.fatal_error("The story could not be loaded. ("+m+"): Error "+n+": "+r)}});if(w){GlkOte.log("GiLoad: trying script load..."),window.processBase64Zcode=function(e){h(y(e))};var k=$("head");if(!k.length)return void p.io.fatal_error("This page has no <head> element!");var b=$("<script>",{src:m,type:"text/javascript"});return void k.get(0).appendChild(b.get(0))}if(i&&_)return GlkOte.log("GiLoad: trying binary load..."),void jQuery.ajax(m,{type:"GET",beforeSend:function(e,n){e.overrideMimeType("text/plain; charset=x-user-defined")},success:function(e,n,r){h(f(e))},error:function(e,n,r){p.io.fatal_error("The story could not be loaded. ("+m+"): Error "+n+": "+r)}});if("file:"==g)return void p.io.fatal_error("The story could not be loaded. ("+m+"): A local file cannot be sent to the proxy.");var x=m;if(v&&(x=r(m),GlkOte.log("GiLoad: absolutize "+m+" to "+x)),l)return GlkOte.log("GiLoad: trying proxy load... ("+p.proxy_url+")"),void jQuery.ajax(p.proxy_url,{type:"GET",data:{encode:"base64",url:x},error:function(e,n,r){p.io.fatal_error("The story could not be loaded. ("+m+"): Error "+n+": "+r)},success:function(e,n,r){h(y(e))}});var M=p.proxy_url+"?encode=base64&callback=processBase64Zcode&url="+x;GlkOte.log("GiLoad: trying proxy-script load... ("+M+")"),window.processBase64Zcode=function(e){h(y(e))};var k=$("head");if(!k.length)return void p.io.fatal_error("This page has no <head> element!");var b=$("<script>",{src:M,type:"text/javascript"});return void k.append(b)}function n(){var e={},n=location.search.substring(1,location.search.length);if(n.length){var r=n.split("&");n=n.replace(/\+/g," ");for(var t=0;t<r.length;t++){var s=r[t].split("="),a=decodeURIComponent(s[0]),o=2==s.length?decodeURIComponent(s[1]):a;e[a]=o}}return e}function r(e){if(e.match(/^(file|data|http|https):/i))return e;var n=document.createElement("div");return n.innerHTML="<a></a>",n.firstChild.href=e,n.innerHTML=n.innerHTML,n.firstChild.href}function t(e){return v[e]}function s(){return g}function a(e){if(void 0!=p.image_info_map){var n=p.image_info_map[e];if(n)return n}var r=_["Pict:"+e];if(r){var n={image:e};if("JPEG"==r.type?n.type="jpeg":"PNG "==r.type?n.type="png":n.type="????",void 0===r.imagesize){var t=void 0;"JPEG"==r.type?t=d(r.content):"PNG "==r.type&&(t=u(r.content)),t&&(r.imagesize=t)}r.imagesize&&(n.width=r.imagesize.width,n.height=r.imagesize.height);var s=w["Pict:"+e];return s&&(n.alttext=s),n}}function o(e){if(p.image_info_map){var n=p.image_info_map[e];if(n&&n.url)return r(n.url)}var t=_["Pict:"+e];if(t){if(t.dataurl)return t.dataurl;var s=a(e);if(s&&t.content){var o="application/octet-stream";"JPEG"==t.type?o="image/jpeg":"PNG "==t.type&&(o="image/png");var i=b(t.content);return t.dataurl="data:"+o+";base64,"+i,t.dataurl}}}function i(e){var n=_["Data:"+e];if(!n)return null;var r=n.type;return"FORM"==r&&(r="BINA"),{data:n.content,type:r}}function l(e){for(var n,r=e.length,t=[],s=null,a=12;a<r;){var o=String.fromCharCode(e[a+0],e[a+1],e[a+2],e[a+3]);a+=4;var i=e[a+0]<<24|e[a+1]<<16|e[a+2]<<8|e[a+3];if(a+=4,"RIdx"==o){var l=a,f=e[l+0]<<24|e[l+1]<<16|e[l+2]<<8|e[l+3];for(l+=4,n=0;n<f;n++){var u=String.fromCharCode(e[l+0],e[l+1],e[l+2],e[l+3]);l+=4;var d=e[l+0]<<24|e[l+1]<<16|e[l+2]<<8|e[l+3];l+=4;var h=e[l+0]<<24|e[l+1]<<16|e[l+2]<<8|e[l+3];l+=4,t.push({usage:u,num:d,pos:h})}}if("IFmd"==o){var m=e.slice(a,a+i),k=c(m),b=$("<metadata>").html(k),y=b.find("bibliographic").children();if(y.length){var x;for(n=0;n<y.length;n++)x=y[n],v[x.tagName.toLowerCase()]=x.textContent}}if("Dbug"==o&&p.debug_info_chunk){var m=e.slice(a,a+i);g=m}if("RDes"==o){var l=a,M=e[l+0]<<24|e[l+1]<<16|e[l+2]<<8|e[l+3];for(l+=4,n=0;n<M;n++){var z=String.fromCharCode.apply(this,e.slice(l,l+4));l+=4;var S=e[l+0]<<24|e[l+1]<<16|e[l+2]<<8|e[l+3];l+=4;var C=e[l+0]<<24|e[l+1]<<16|e[l+2]<<8|e[l+3];l+=4;var G=c(e.slice(l,l+C));l+=C,w[z+":"+S]=G}}a+=i,1&a&&a++}for(n=0;n<t.length;n++){var x=t[n];a=x.pos;var o=String.fromCharCode(e[a+0],e[a+1],e[a+2],e[a+3]);a+=4;var i=e[a+0]<<24|e[a+1]<<16|e[a+2]<<8|e[a+3];a+=4,x.type=o,x.len=i,x.content=null,"Exec"==x.usage&&0==x.num&&"GLUL"==o?s=e.slice(a,a+i):("FORM"==o?x.content=e.slice(a-8,a+i):x.content=e.slice(a,a+i),_[x.usage+":"+x.num]=x)}return s}function f(e){var n,r=Array(e.length);for(n=0;n<e.length;n++)r[n]=255&e.charCodeAt(n);return r}function c(e){for(var n,r=[],t=0;t<e.length;){var s,a,o,i;if(t>=e.length)break;if(s=e[t],t++,s<128)n=s;else{if(t>=e.length)break;if(a=e[t],t++,128!=(192&a))break;if(192==(224&s))n=(31&s)<<6,n|=63&a;else{if(t>=e.length)break;if(o=e[t],t++,128!=(192&o))break;if(224==(240&s))n=(15&s)<<12&61440,n|=(63&a)<<6&4032,n|=63&o&63;else{if(240!=(240&s))break;if(t>=e.length)break;if(i=e[t],t++,128!=(192&i))break;n=(7&s)<<18&1835008,n|=(63&a)<<12&258048,n|=(63&o)<<6&4032,n|=63&i&63}}}r.push(n)}return String.fromCharCode.apply(this,r)}function u(e){var n=0;if(137!=e[0]||"PNG"!=String.fromCharCode.apply(this,e.slice(1,4)))return void GlkOte.log("find_dimensions_png: PNG signature does not match");for(n+=8;n<e.length;){var r=e[n+0]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3];n+=4;var t=String.fromCharCode.apply(this,e.slice(n,n+4));if(n+=4,"IHDR"==t){var s={};return s.width=e[n+0]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3],n+=4,s.height=e[n+0]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3],n+=4,s}n+=r,n+=4}GlkOte.log("find_dimensions_png: no PNG header block found")}function d(e){for(var n=0;n<e.length;){if(255!=e[n])return void GlkOte.log("find_dimensions_jpeg: marker is not 0xFF");for(;255==e[n];)n+=1;var r=e[n];if(n+=1,!(1==r||r>=208&&r<=217)){var t=e[n+0]<<8|e[n+1];if(r>=192&&r<=207&&200!=r){if(t<7)return void GlkOte.log("find_dimensions_jpeg: SOF block is too small");var s={};return s.height=e[n+3]<<8|e[n+4],s.width=e[n+5]<<8|e[n+6],s}n+=t}}GlkOte.log("find_dimensions_jpeg: no SOF marker found")}function h(e){if(0==e.length)return void p.io.fatal_error("No game file was loaded. (Zero-length response.)");if(70==e[0]&&79==e[1]&&82==e[2]&&77==e[3]){var n=String.fromCharCode(e[8],e[9],e[10],e[11]);if("IFZS"==n)return void p.io.fatal_error("This is a saved-game file, not a Glulx game file. You must launch the game first, then restore your save.");if("IFRS"!=n)return void p.io.fatal_error("This IFF file is not a Blorb file!");try{e=l(e)}catch(e){return void p.io.fatal_error("Blorb file could not be parsed: "+e)}if(!e)return void p.io.fatal_error("Blorb file contains no Glulx game!")}var r=null;v&&(r=v.title),!r&&m&&(r=m.slice(m.lastIndexOf("/")+1)),r||(r=p.default_page_title),r||(r="Game"),p.recording_label||(p.recording_label=r),p.set_page_title&&(document.title=r+" - Quixe"),p.vm.prepare(e,p),p.io.init(p)}var p={vm:null,io:null,spacing:4,use_query_story:!0,default_story:null,set_page_title:!0,default_page_title:"Game",exit_warning:"The game session has ended.",image_info_map:null,proxy_url:"http://zcode.appspot.com/proxy/"},m=null,v={},g=null,_={},w={};if(window.atob)y=function(e){var n,r=atob(e),t=Array(r.length);for(n=0;n<r.length;n++)t[n]=r.charCodeAt(n);return t};else{var k=function(){var e,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r=[];for(e=0;e<n.length;e++)r[n.charAt(e)]=e;return r}();y=function(e){for(var n,r,t,s,a,o,i,l=[],f=0,c=e.length;f<c;)s=k[e.charAt(f++)],a=k[e.charAt(f++)],o=k[e.charAt(f++)],i=k[e.charAt(f++)],n=(s<<2)+(a>>4),r=((15&a)<<4)+(o>>2),t=((3&o)<<6)+i,l.push(n,r,t);return 64==i&&l.pop(),64==o&&l.pop(),l}}var b,y;return b=window.btoa?function(e){for(var n=[],r=e.length,t=0;t<r;t+=16384)n.push(String.fromCharCode.apply(String,e.slice(t,t+16384)));return btoa(n.join(""))}:function(e){for(var n,r,t,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a=[],o=0;o<e.length;o+=3)n=e[o],r=e[o+1],t=e[o+2],a.push(s.charAt(n>>2&63)),a.push(s.charAt(n<<4&48|r>>4&15)),a.push(s.charAt(r<<2&60|t>>6&3)),a.push(s.charAt(63&t));return void 0===r&&a.length>=2&&(a[a.length-2]="="),void 0===t&&a.length>=1&&(a[a.length-1]="="),a.join("")},{load_run:e,find_data_chunk:i,get_metadata:t,get_debug_info:s,get_image_info:a,get_image_url:o}}();